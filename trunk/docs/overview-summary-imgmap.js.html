<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
imgmap Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="imgmap.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b>imgmap</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>imgmap.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		Online Image Map Editor - main script file.
	This is the main script file of the Online Image Map Editor.
 
	TODO:
	-pic_container dynamic create(pos rel)?
	-scriptload race condition fix
	-destroy/cleanup function ?
	-testing highlighter
	-cursor area_mousemove in opera not refreshing quite well - bug reported
	-get rid of memo array
	-highlight which control point is edited in html or form mode   
	-more comments, especially on config vars
	-make function names more logical
	- dumpconfig   
	-prepare for bad input /poly not properly closed?
	-prepare for % values in coords  
	-prepare for default shape http://www.w3.org/TR/html4/struct/objects.html#edef-AREA
	 
	<BR/><BR/><B>Version: </B>2.0beta6<BR/><BR/><B>Author:</B> Adam Maschek (adam.maschek(at)gmail.com)
	<BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="imgmap.html">imgmap</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

	<a name="method_summary"><!-- --></a>
	<table border="1" cellpadding="3" cellspacing="0" width="100%">
		<tr bgcolor="#CCCCFF" class="TableHeadingColor">
			<td colspan=2>
				<font size="+2">
					<b>Method Summary</b>
				</font>
			</td>
		</tr>
	
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;void</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#!s!imgmap_spawnObjects">imgmap_spawnObjects</a></b>(config)
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 Spawn an imgmap object for each imagemap found in the document.
		      </td>
		   </tr>
		
	
	</table>
    <p>

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/**
 *	Image Map Editor (imgmap) - in-browser imagemap editor
 *	Copyright (C) 2006 - 2008 Adam Maschek (adam.maschek @ gmail.com)
 *	
 *	This program is free software; you can redistribute it and/or
 *	modify it under the terms of the GNU General Public License
 *	as published by the Free Software Foundation; either version 2
 *	of the License, or (at your option) any later version.
 *	
 *	This program is distributed in the hope that it will be useful,
 *	but WITHOUT ANY WARRANTY; without even the implied warranty of
 *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *	GNU General Public License for more details.
 *	
 *	You should have received a copy of the GNU General Public License
 *	along with this program; if not, write to the Free Software
 *	Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 */</span>
<span class="comment">/**
 *	<span class="attrib">@fileoverview</span>
 *	Online Image Map Editor - main script file.
 *	This is the main script file of the Online Image Map Editor.
 * 
 *	TODO:
 *	-pic_container dynamic create(pos rel)?
 *	-scriptload race condition fix
 *	-destroy/cleanup function ?
 *	-testing highlighter
 *	-cursor area_mousemove in opera not refreshing quite well - bug reported
 *	-get rid of memo array
 *	-highlight which control point is edited in html or form mode   
 *	-more comments, especially on config vars
 *	-make function names more logical
 *	- dumpconfig   
 *	-prepare for bad input /poly not properly closed?
 *	-prepare for % values in coords  
 *	-prepare for default shape http://www.w3.org/TR/html4/struct/objects.html#edef-AREA
 *	 
 *	<span class="attrib">@date</span>	26-02-2007 2:24:50
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@copyright</span>
 *	<span class="attrib">@version</span> 2.0beta6
 *	 
 */</span>
<span class="comment">/**
 *	<span class="attrib">@author</span>	Adam Maschek
 *	<span class="attrib">@constructor</span>
 *	<span class="attrib">@param</span> config	The config object. 
 */</span>
<span class="reserved">function</span> imgmap(config) {
	<span class="reserved">this</span>.version = <span class="literal">"2.0beta6"</span>;
	<span class="reserved">this</span>.buildDate = <span class="literal">"2008/10/30 12:24"</span>;
	<span class="reserved">this</span>.buildNumber = <span class="literal">"87"</span>;
	
	<span class="comment">/** Config object of the imgmap instance */</span>
	<span class="reserved">this</span>.config = {};
	
	<span class="comment">/** Status flag to indicate current drawing mode */</span>
	<span class="reserved">this</span>.is_drawing = 0;
	
	<span class="comment">/**	Array to hold language strings */</span>
	<span class="reserved">this</span>.strings   = [];
	
	<span class="comment">/** Helper array for some drawing operations */</span>
	<span class="reserved">this</span>.memory    = [];
	
	<span class="comment">/**	Array to hold reference to all areas (canvases) */</span>
	<span class="reserved">this</span>.areas     = [];
	
	<span class="comment">/**	Array to hold last log entries */</span>
	<span class="reserved">this</span>.logStore  = [];
	
	<span class="reserved">this</span>.currentid = 0;
	<span class="reserved">this</span>.draggedId  = null;
	<span class="reserved">this</span>.selectedId = null;
	<span class="reserved">this</span>.nextShape = <span class="literal">'rect'</span>;

	<span class="comment">/** possible values: 0 - edit, 1 - preview */</span>
	<span class="reserved">this</span>.viewmode  = 0;
	
	<span class="comment">/** array of dynamically loaded javascripts */</span>
	<span class="reserved">this</span>.loadedScripts = [];
	<span class="reserved">this</span>.isLoaded   = false;
	<span class="reserved">this</span>.cntReloads = 0;
	
	<span class="comment">/**	holds the name of the actively edited map, use getMapName to read it */</span>
	<span class="reserved">this</span>.mapname    = <span class="literal">''</span>;
	
	<span class="comment">/**	holds the id of the actively edited map, use getMapIdto read it */</span>
	<span class="reserved">this</span>.mapid      = <span class="literal">''</span>;
	
	<span class="comment">/** watermark to attach to output */</span>
	<span class="reserved">this</span>.waterMark  = <span class="literal">'&lt;!-- Created by Online Image Map Editor (http://www.maschek.hu/imagemap/index) --&gt;'</span>;

	<span class="comment">/** is_drawing draw mode constants */</span> 
	<span class="reserved">this</span>.DM_RECTANGLE_DRAW          = 1;
	<span class="reserved">this</span>.DM_RECTANGLE_MOVE          = 11;
	<span class="reserved">this</span>.DM_RECTANGLE_RESIZE_TOP    = 12;
	<span class="reserved">this</span>.DM_RECTANGLE_RESIZE_RIGHT  = 13;
	<span class="reserved">this</span>.DM_RECTANGLE_RESIZE_BOTTOM = 14;
	<span class="reserved">this</span>.DM_RECTANGLE_RESIZE_LEFT   = 15;
	
	<span class="reserved">this</span>.DM_SQUARE_DRAW             = 2;
	<span class="reserved">this</span>.DM_SQUARE_MOVE             = 21;
	<span class="reserved">this</span>.DM_SQUARE_RESIZE_TOP       = 22;
	<span class="reserved">this</span>.DM_SQUARE_RESIZE_RIGHT     = 23;
	<span class="reserved">this</span>.DM_SQUARE_RESIZE_BOTTOM    = 24;
	<span class="reserved">this</span>.DM_SQUARE_RESIZE_LEFT      = 25;
	
	<span class="reserved">this</span>.DM_POLYGON_DRAW            = 3;
	<span class="reserved">this</span>.DM_POLYGON_LASTDRAW        = 30;
	<span class="reserved">this</span>.DM_POLYGON_MOVE            = 31;

	<span class="comment">//set some config defaults</span>
	<span class="reserved">this</span>.config.mode     = <span class="literal">"editor"</span>;
	<span class="comment">//possible values: editor - classical editor, editor2 - dreamweaver style editor, highlighter - map highlighter</span>
	
	<span class="reserved">this</span>.config.baseroot    = <span class="literal">''</span>;
	<span class="reserved">this</span>.config.lang        = <span class="literal">''</span>;
	<span class="reserved">this</span>.config.defaultLang = <span class="literal">'en'</span>;
	<span class="reserved">this</span>.config.loglevel    = 0;
	<span class="reserved">this</span>.config.custom_callbacks = {};<span class="comment">//possible values: see below!</span>
	
	<span class="comment">/**	Callback events that you can handle in your gui. */</span>
	<span class="reserved">this</span>.event_types        = [
		<span class="literal">'onModeChanged'</span>,
		<span class="literal">'onClipboard'</span>,
		<span class="literal">'onHtmlChanged'</span>,
		<span class="literal">'onAddArea'</span>,
		<span class="literal">'onRemoveArea'</span>,
		<span class="literal">'onDrawArea'</span>, 
		<span class="literal">'onResizeArea'</span>,
		<span class="literal">'onRelaxArea'</span>,
		<span class="literal">'onFocusArea'</span>,
		<span class="literal">'onBlurArea'</span>,
		<span class="literal">'onMoveArea'</span>,
		<span class="literal">'onSelectRow'</span>,
		<span class="literal">'onLoadImage'</span>, 
		<span class="literal">'onSetMap'</span>,
		<span class="literal">'onGetMap'</span>,
		<span class="literal">'onSelectArea'</span>,
		<span class="literal">'onStatusMessage'</span>,
		<span class="literal">'onAreaChanged'</span>];

	<span class="comment">//default color values</span>
	<span class="reserved">this</span>.config.CL_DRAW_BOX        = <span class="literal">'#dd2400'</span>;
	<span class="reserved">this</span>.config.CL_DRAW_SHAPE      = <span class="literal">'#d00'</span>;
	<span class="reserved">this</span>.config.CL_DRAW_BG         = <span class="literal">'#fff'</span>;
	<span class="reserved">this</span>.config.CL_NORM_BOX        = <span class="literal">'#dd2400'</span>;
	<span class="reserved">this</span>.config.CL_NORM_SHAPE      = <span class="literal">'#d00'</span>;
	<span class="reserved">this</span>.config.CL_NORM_BG         = <span class="literal">'#fff'</span>;
	<span class="reserved">this</span>.config.CL_HIGHLIGHT_BOX   = <span class="literal">'#dd2400'</span>;
	<span class="reserved">this</span>.config.CL_HIGHLIGHT_SHAPE = <span class="literal">'#d00'</span>;
	<span class="reserved">this</span>.config.CL_HIGHLIGHT_BG    = <span class="literal">'#fff'</span>;
	<span class="reserved">this</span>.config.CL_KNOB            = <span class="literal">'#ffeeee'</span>;

	<span class="reserved">this</span>.config.bounding_box       = true;
	<span class="reserved">this</span>.config.label              = <span class="literal">'%n'</span>;
	<span class="comment">//the format string of the area labels - possible values: %n - number, %c - coords, %h - href, %a - alt, %t - title</span>
	
	<span class="reserved">this</span>.config.label_class        = <span class="literal">'imgmap_label'</span>;
	<span class="comment">//the css class to apply on labels</span>
	<span class="reserved">this</span>.config.label_style        = <span class="literal">'font: bold 10px Arial'</span>;
	<span class="comment">//this.config.label_style        = 'font-weight: bold; font-size: 10px; font-family: Arial; color: #964';</span>
	<span class="comment">//the css style(s) to apply on labels</span>
	
	<span class="reserved">this</span>.config.hint               = <span class="literal">'#%n %h'</span>;
	<span class="comment">//the format string of the area mouseover hints - possible values: %n - number, %c - coords, %h - href, %a - alt, %t - title</span>

	<span class="reserved">this</span>.config.draw_opacity       = <span class="literal">'35'</span>;
	<span class="comment">//the opacity value of the area while drawing, moving or resizing - possible values 0 - 100 or range "(x)-y"	</span>
	<span class="reserved">this</span>.config.norm_opacity       = <span class="literal">'50'</span>;
	<span class="comment">//the opacity value of the area while relaxed - possible values 0 - 100	or range "(x)-y"</span>
	<span class="reserved">this</span>.config.highlight_opacity  = <span class="literal">'70'</span>;
	<span class="comment">//the opacity value of the area while highlighted - possible values 0 - 100 or range "(x)-y"</span>
	<span class="reserved">this</span>.config.cursor_default     = <span class="literal">'crosshair'</span>;		<span class="comment">//auto/pointer</span>
	<span class="comment">//the css cursor while hovering over the image</span>
	
	<span class="comment">//browser sniff</span>
	var ua = navigator.userAgent;
	<span class="reserved">this</span>.isMSIE    = (navigator.appName == <span class="literal">"Microsoft Internet Explorer"</span>);
	<span class="reserved">this</span>.isMSIE5   = <span class="reserved">this</span>.isMSIE &amp;&amp; (ua.indexOf(<span class="literal">'MSIE 5'</span>)   != -1);
	<span class="reserved">this</span>.isMSIE5_0 = <span class="reserved">this</span>.isMSIE &amp;&amp; (ua.indexOf(<span class="literal">'MSIE 5.0'</span>) != -1);
	<span class="reserved">this</span>.isMSIE7   = <span class="reserved">this</span>.isMSIE &amp;&amp; (ua.indexOf(<span class="literal">'MSIE 7'</span>)   != -1);
	<span class="reserved">this</span>.isGecko   = ua.indexOf(<span class="literal">'Gecko'</span>)  != -1;
	<span class="reserved">this</span>.isSafari  = ua.indexOf(<span class="literal">'Safari'</span>) != -1;
	<span class="reserved">this</span>.isOpera   = (typeof window.opera != <span class="literal">'undefined'</span>);

	<span class="reserved">this</span>.addEvent(document, <span class="literal">'keydown'</span>,   <span class="reserved">this</span>.doc_keydown.bind(<span class="reserved">this</span>));
	<span class="reserved">this</span>.addEvent(document, <span class="literal">'keyup'</span>,     <span class="reserved">this</span>.doc_keyup.bind(<span class="reserved">this</span>));
	<span class="reserved">this</span>.addEvent(document, <span class="literal">'mousedown'</span>, <span class="reserved">this</span>.doc_mousedown.bind(<span class="reserved">this</span>));
	
	<span class="reserved">if</span> (config) {
		<span class="reserved">this</span>.setup(config);
	}
	
}


<span class="comment">/**
 *	Return an object given by id or object itself.
 *	<span class="attrib">@date</span>	22-02-2007 0:14:50
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@param</span>	objorid	A DOM object, or id of a DOM object.
 *	<span class="attrib">@return</span>	The identified DOM object or null on error.  
 */</span>
imgmap.<span class="reserved">prototype</span>.assignOID = <span class="reserved">function</span>(objorid) {
	try {
		<span class="reserved">if</span> (typeof objorid == <span class="literal">'undefined'</span>) {
			<span class="reserved">this</span>.log(<span class="literal">"Undefined object passed to assignOID."</span>);<span class="comment">// Called from: " + arguments.callee.caller, 1);</span>
			<span class="reserved">return</span> null;
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (typeof objorid == <span class="literal">'object'</span>) {
			<span class="reserved">return</span> objorid;
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (typeof objorid == <span class="literal">'string'</span>) {
			<span class="reserved">return</span> document.getElementById(objorid);
		}
	}
	catch (err) {
		<span class="reserved">this</span>.log(<span class="literal">"Error in assignOID"</span>, 1);
	}
	<span class="reserved">return</span> null;
};


<span class="comment">/**
 *	Main setup function.
 *	Can be called manually or constructor will call it.
 *	<span class="attrib">@date</span>	22-02-2007 0:15:42
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@param</span>	config	config object
 *	<span class="attrib">@return</span>	True if all went ok.  
 */</span>
imgmap.<span class="reserved">prototype</span>.setup = <span class="reserved">function</span>(config) {
	<span class="comment">//this.config = config;</span>
	<span class="reserved">for</span> (var i in config) {
		<span class="reserved">this</span>.config[i] = config[i];
	}
	<span class="comment">//this.log('setup');</span>
	<span class="comment">//set container elements - supposedly they already exist in the DOM</span>
	<span class="reserved">if</span> (config) {
		<span class="reserved">this</span>.pic_container = <span class="reserved">this</span>.assignOID(config.pic_container);
		<span class="reserved">this</span>.disableSelection(<span class="reserved">this</span>.pic_container);
	}
	
	<span class="reserved">if</span> (!<span class="reserved">this</span>.config.baseroot) {
		<span class="comment">//search for a base - theoretically there can only be one, but lets search</span>
		<span class="comment">//for the first non-empty</span>
		var bases = document.getElementsByTagName(<span class="literal">'base'</span>);
		var base  = <span class="literal">''</span>;
		<span class="reserved">for</span> (i=0; i&lt;bases.length; i++) {<span class="comment">//i declared earlier</span>
			<span class="reserved">if</span> (bases[i].href) {
				base = bases[i].href;
				<span class="comment">//append slash if missing</span>
				<span class="reserved">if</span> (base.charAt(base.length-1) != <span class="literal">'/'</span>) {
					base+= <span class="literal">'/'</span>;
				}
				break;
			}
		}
		<span class="comment">//search for scripts</span>
		var scripts = document.getElementsByTagName(<span class="literal">'script'</span>);
		<span class="reserved">for</span> (i=0; i&lt;scripts.length; i++) {<span class="comment">//i declared earlier</span>
			<span class="reserved">if</span> (scripts[i].src &amp;&amp; scripts[i].src.match(/imgmap\w*\.js(\?.*?)?$/)) {
				var src = scripts[i].src;
				<span class="comment">//cut filename part, leave last slash</span>
				src = src.substring(0, src.lastIndexOf(<span class="literal">'/'</span>) + 1);
				<span class="comment">//set final baseroot path</span>
				<span class="reserved">if</span> (base &amp;&amp; src.indexOf(<span class="literal">'://'</span>) == -1) {
					<span class="reserved">this</span>.config.baseroot = base + src;
				}
				<span class="reserved">else</span> {
					<span class="reserved">this</span>.config.baseroot = src;
				}
				<span class="comment">//exit loop</span>
				break;
			}
		}
	}

	<span class="comment">//load excanvas js - as soon as possible</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.isMSIE &amp;&amp;
		typeof window.CanvasRenderingContext2D == <span class="literal">'undefined'</span> &amp;&amp; typeof G_vmlCanvasManager == <span class="literal">'undefined'</span>) { 
		<span class="reserved">this</span>.loadScript(<span class="reserved">this</span>.config.baseroot + <span class="literal">'excanvas.js'</span>);
		<span class="comment">//alert('loadcanvas');</span>
	}
	<span class="comment">//alert(this.config.baseroot);</span>

	<span class="comment">//load language js - as soon as possible</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.config.lang) {
		<span class="reserved">this</span>.config.lang = <span class="reserved">this</span>.detectLanguage();
	}
	<span class="reserved">this</span>.loadScript(<span class="reserved">this</span>.config.baseroot + <span class="literal">'lang_'</span> + <span class="reserved">this</span>.config.lang + <span class="literal">'.js'</span>);
	
	<span class="comment">//check event hooks</span>
	var found, j;
	<span class="reserved">for</span> (i in <span class="reserved">this</span>.config.custom_callbacks) {
		found = false;
		<span class="reserved">for</span> (j=0; j&lt;<span class="reserved">this</span>.event_types.length; j++) {
			<span class="reserved">if</span> (i == <span class="reserved">this</span>.event_types[j]) {
				found = true;
				break;
			}
		}
		<span class="reserved">if</span> (!found) {
			<span class="reserved">this</span>.log(<span class="literal">"Unknown custom callback: "</span> + i, 1);
		}
	}
	
	<span class="comment">//hook onload event - as late as possible</span>
	<span class="reserved">this</span>.addEvent(window, <span class="literal">'load'</span>, <span class="reserved">this</span>.onLoad.bind(<span class="reserved">this</span>));
	<span class="reserved">return</span> true;
};


<span class="comment">/**
 *	currently unused
 *	<span class="attrib">@ignore</span>
 */</span>
imgmap.<span class="reserved">prototype</span>.retryDelayed = <span class="reserved">function</span>(fn, delay, tries) {
	<span class="reserved">if</span> (typeof fn.tries == <span class="literal">'undefined'</span>) {fn.tries = 0;}
	<span class="comment">//alert(fn.tries+1);</span>
	<span class="reserved">if</span> (fn.tries++ &lt; tries) {
		<span class="comment">//alert('ss');</span>
		window.setTimeout(<span class="reserved">function</span>() {
		fn.apply(<span class="reserved">this</span>);
		}, delay);
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handle event when the page with scripts is loaded.
 *	<span class="attrib">@date</span>	22-02-2007 0:16:22
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 */</span>
imgmap.<span class="reserved">prototype</span>.onLoad = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.isLoaded) {<span class="reserved">return</span> true;}
	var _this = <span class="reserved">this</span>;
	<span class="comment">//this.log('readystate: ' +  document.readyState);</span>
	<span class="reserved">if</span> (typeof imgmapStrings == <span class="literal">'undefined'</span>) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.cntReloads++ &lt; 5) {
			<span class="comment">//this.retryDelayed(_this.onLoad(), 1000, 3);</span>
			window.setTimeout(<span class="reserved">function</span> () {_this.onLoad(e);} ,1200);
			<span class="reserved">this</span>.log(<span class="literal">'Delaying onload (language '</span> + <span class="reserved">this</span>.config.lang + <span class="literal">' not loaded, try: '</span> + <span class="reserved">this</span>.cntReloads + <span class="literal">')'</span>);
			<span class="reserved">return</span> false;
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.config.lang != <span class="reserved">this</span>.config.defaultLang &amp;&amp; <span class="reserved">this</span>.config.defaultLang != <span class="literal">'en'</span>) {
			<span class="reserved">this</span>.log(<span class="literal">'Falling back to default language: '</span> + <span class="reserved">this</span>.config.defaultLang);
			<span class="reserved">this</span>.cntReloads = 0;
			<span class="reserved">this</span>.config.lang = <span class="reserved">this</span>.config.defaultLang;
			<span class="reserved">this</span>.loadScript(<span class="reserved">this</span>.config.baseroot + <span class="literal">'lang_'</span> + <span class="reserved">this</span>.config.lang + <span class="literal">'.js'</span>);
			window.setTimeout(<span class="reserved">function</span> () {_this.onLoad(e);} ,1200);
			<span class="reserved">return</span> false;
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.config.lang != <span class="literal">'en'</span>) {
			<span class="reserved">this</span>.log(<span class="literal">'Falling back to english language'</span>);
			<span class="reserved">this</span>.cntReloads = 0;
			<span class="reserved">this</span>.config.lang = <span class="literal">'en'</span>;
			<span class="reserved">this</span>.loadScript(<span class="reserved">this</span>.config.baseroot + <span class="literal">'lang_'</span> + <span class="reserved">this</span>.config.lang + <span class="literal">'.js'</span>);
			window.setTimeout(<span class="reserved">function</span> () {_this.onLoad(e);} ,1200);
			<span class="reserved">return</span> false;
		}
	}
	<span class="comment">//else</span>
	try {
		<span class="reserved">this</span>.loadStrings(imgmapStrings);
	}
	catch (err) {
		<span class="reserved">this</span>.log(<span class="literal">"Unable to load language strings"</span>, 1);
	}
	
	<span class="comment">//check if ExplorerCanvas correctly loaded - detect if browser supports canvas</span>
	<span class="comment">//alert(typeof G_vmlCanvasManager + this.isMSIE + typeof window.CanvasRenderingContext2D);</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.isMSIE) {
		<span class="comment">//alert('cccc');</span>
		<span class="comment">//alert(typeof G_vmlCanvasManager);</span>
		<span class="reserved">if</span> (typeof window.CanvasRenderingContext2D == <span class="literal">'undefined'</span> &amp;&amp; typeof G_vmlCanvasManager == <span class="literal">'undefined'</span>) {
			<span class="comment">//alert('bbb');</span>
			<span class="comment">/*
			if (this.cntReloads++ &lt; 5) {
				var _this = this;
				//this.retryDelayed(_this.onLoad(), 1000, 3);
				window.setTimeout(function () {
					_this.onLoad(e);
					}
					,1000
					);
				//alert('aaa');
				this.log('Delaying onload (excanvas not loaded, try: ' + this.cntReloads + ')');
				return false;
			}
			*/</span>
			<span class="reserved">this</span>.log(<span class="reserved">this</span>.strings.ERR_EXCANVAS_LOAD, 2);<span class="comment">//critical error</span>
		}
	}
	
	<span class="reserved">if</span> (<span class="reserved">this</span>.config.mode == <span class="literal">'highlighter'</span>) {
		<span class="comment">//call global scope function</span>
		imgmap_spawnObjects(<span class="reserved">this</span>.config);	
	}
	<span class="reserved">this</span>.isLoaded = true;
	<span class="reserved">return</span> true;
};


<span class="comment">/**
 *	Attach new 'evt' event handler 'callback' to 'obj'
 *	<span class="attrib">@date</span>	24-02-2007 21:16:20
 */</span>
imgmap.<span class="reserved">prototype</span>.addEvent = <span class="reserved">function</span>(obj, evt, callback) {
	<span class="reserved">if</span> (obj.attachEvent) {
		<span class="comment">//Microsoft style registration model</span>
		<span class="reserved">return</span> obj.attachEvent(<span class="literal">"on"</span> + evt, callback);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (obj.addEventListener) {
		<span class="comment">//W3C style model</span>
		obj.addEventListener(evt, callback, false);
		<span class="reserved">return</span> true;
	}
	<span class="reserved">else</span> {
		obj[<span class="literal">'on'</span> + evt] = callback;
	}
};


<span class="comment">/**
 *	Detach an event from an object
 *	<span class="attrib">@date</span>	24-11-2007 15:22:17
 */</span>
imgmap.<span class="reserved">prototype</span>.removeEvent = <span class="reserved">function</span>(obj, evt, callback) {
	<span class="reserved">if</span> (obj.detachEvent) {
		<span class="comment">//Microsoft style detach model</span>
		<span class="reserved">return</span> obj.detachEvent(<span class="literal">"on"</span> + evt, callback);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (obj.removeEventListener) {
		<span class="comment">//W3C style model</span>
		obj.removeEventListener(evt, callback, false);
		<span class="reserved">return</span> true;
	}
	<span class="reserved">else</span> {
		obj[<span class="literal">'on'</span> + evt] = null;
	}
};


<span class="comment">/**
 *	We need this because load events for scripts function slightly differently.
 *	<span class="attrib">@link</span>	http://dean.edwards.name/weblog/2006/06/again/
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	24-03-2007 11:02:21
 */</span>
imgmap.<span class="reserved">prototype</span>.addLoadEvent = <span class="reserved">function</span>(obj, callback) {
	<span class="reserved">if</span> (obj.attachEvent) {
		<span class="comment">//Microsoft style registration model</span>
		<span class="reserved">return</span> obj.attachEvent(<span class="literal">"onreadystatechange"</span>, callback);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (obj.addEventListener) {
		<span class="comment">//W3C style registration model</span>
		obj.addEventListener(<span class="literal">'load'</span>, callback, false);
		<span class="reserved">return</span> true;
	}
	<span class="reserved">else</span> {
		obj.onload = callback;
	}
};


<span class="comment">/**
 *	Include another js script into the current document.
 *	<span class="attrib">@date</span>	22-02-2007 0:17:04
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@param</span>	url	The url of the script we want to load.
 *	<span class="attrib">@see</span>	#script_load
 *	<span class="attrib">@see</span>	#addLoadEvent
 */</span>
imgmap.<span class="reserved">prototype</span>.loadScript = <span class="reserved">function</span>(url) {
	<span class="reserved">if</span> (url === <span class="literal">''</span>) {<span class="reserved">return</span> false;}
	<span class="reserved">if</span> (<span class="reserved">this</span>.loadedScripts[url] == 1) {<span class="reserved">return</span> true;}<span class="comment">//script already loaded</span>
	<span class="reserved">this</span>.log(<span class="literal">'Loading script: '</span> + url);
	<span class="comment">//we might need this someday for safari?</span>
	<span class="comment">//var temp = '&lt;script language="javascript" type="text/javascript" src="' + url + '"&gt;&lt;/script&gt;';</span>
	<span class="comment">//document.write(temp);</span>
	try {
		var head = document.getElementsByTagName(<span class="literal">'head'</span>)[0];
		var temp = document.createElement(<span class="literal">'SCRIPT'</span>);
		temp.setAttribute(<span class="literal">'language'</span>, <span class="literal">'javascript'</span>);
		temp.setAttribute(<span class="literal">'type'</span>, <span class="literal">'text/javascript'</span>);
		temp.setAttribute(<span class="literal">'src'</span>, url);
		<span class="comment">//temp.setAttribute('defer', true);</span>
		head.appendChild(temp);
		<span class="reserved">this</span>.addLoadEvent(temp, <span class="reserved">this</span>.script_load.bind(<span class="reserved">this</span>));
	}
	catch (err) {
		<span class="reserved">this</span>.log(<span class="literal">'Error loading script: '</span> + url);
	}
	<span class="reserved">return</span> true;
};


<span class="comment">/**
 *	EVENT HANDLER: Event handler of external script loaded.
 *	<span class="attrib">@param</span>	e	The event object. 
 */</span>
imgmap.<span class="reserved">prototype</span>.script_load = <span class="reserved">function</span>(e) {
	var obj = (<span class="reserved">this</span>.isMSIE) ? window.event.srcElement : e.currentTarget;
	var url = obj.src;
	var complete = false;
	<span class="comment">//alert(url);</span>
	<span class="reserved">if</span> (typeof obj.readyState != <span class="literal">'undefined'</span>) {
		<span class="comment">//explorer</span>
		<span class="reserved">if</span> (obj.readyState == <span class="literal">'complete'</span>) {
			complete = true;
		}
	}
	<span class="reserved">else</span> {
		<span class="comment">//other browsers?</span>
		complete = true;
	}
	<span class="reserved">if</span> (complete) {
		<span class="reserved">this</span>.loadedScripts[url] = 1;
		<span class="reserved">this</span>.log(<span class="literal">'Loaded script: '</span> + url);
		<span class="reserved">return</span> true;
	}
};


<span class="comment">/**
 *	Load strings from a key:value object to the prototype strings array.
 *	<span class="attrib">@author</span> adam
 *	<span class="attrib">@date</span>	2007
 *	<span class="attrib">@param</span>	obj	Javascript object that holds key:value pairs.
 */</span>
imgmap.<span class="reserved">prototype</span>.loadStrings = <span class="reserved">function</span>(obj) {
	<span class="reserved">for</span> (var key in obj) {
		<span class="reserved">this</span>.strings[key] = obj[key];
	}
};


<span class="comment">/**
 *	This function is to load a given img url to the pic_container.
 *	
 *	Loading an image will clear all current maps.
 *	   
 *	<span class="attrib">@param</span> img The imageurl or object to load (if object, function will get url, and do a recall)
 *	<span class="attrib">@param</span> imgw The width we want to force on the image	  
 *	<span class="attrib">@param</span> imgh The height we want to force on the image	 
 */</span>
imgmap.<span class="reserved">prototype</span>.loadImage = <span class="reserved">function</span>(img, imgw, imgh) {
	<span class="comment">//wipe all</span>
	<span class="reserved">this</span>.removeAllAreas();
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onHtmlChanged'</span>, <span class="literal">''</span>);<span class="comment">//empty</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>._getLastArea()) {
		<span class="comment">//init with one new area if there was none editable</span>
		<span class="reserved">if</span> (<span class="reserved">this</span>.config.mode != <span class="literal">"editor2"</span>) {<span class="reserved">this</span>.addNewArea();}
	}
	<span class="reserved">if</span> (typeof img == <span class="literal">'string'</span>) {
		<span class="comment">//there is an image given with url to load</span>
		<span class="reserved">if</span> (typeof <span class="reserved">this</span>.pic == <span class="literal">'undefined'</span>) {
			<span class="reserved">this</span>.pic = document.createElement(<span class="literal">'IMG'</span>);
			<span class="reserved">this</span>.pic_container.appendChild(<span class="reserved">this</span>.pic);
			<span class="comment">//event handler hooking</span>
			<span class="reserved">this</span>.addEvent(<span class="reserved">this</span>.pic, <span class="literal">'mousedown'</span>, <span class="reserved">this</span>.img_mousedown.bind(<span class="reserved">this</span>));
			<span class="reserved">this</span>.addEvent(<span class="reserved">this</span>.pic, <span class="literal">'mouseup'</span>,   <span class="reserved">this</span>.img_mouseup.bind(<span class="reserved">this</span>));
			<span class="reserved">this</span>.addEvent(<span class="reserved">this</span>.pic, <span class="literal">'mousemove'</span>, <span class="reserved">this</span>.img_mousemove.bind(<span class="reserved">this</span>));
			<span class="reserved">this</span>.pic.style.cursor = <span class="reserved">this</span>.config.cursor_default;
		}
		<span class="comment">//img ='../../'+img;</span>
		<span class="reserved">this</span>.log(<span class="literal">'Loading image: '</span> + img, 0);
		<span class="comment">//calculate timestamp to bypass browser cache mechanism</span>
		var q = <span class="literal">'?'</span>;
		<span class="reserved">if</span> (img.indexOf(<span class="literal">'?'</span>) &gt; -1) {
			q = <span class="literal">'&amp;'</span>;
		}
		<span class="reserved">this</span>.pic.src = img + q + (new Date().getTime());
		<span class="reserved">if</span> (imgw &amp;&amp; imgw &gt; 0) {<span class="reserved">this</span>.pic.setAttribute(<span class="literal">'width'</span>,  imgw);}
		<span class="reserved">if</span> (imgh &amp;&amp; imgh &gt; 0) {<span class="reserved">this</span>.pic.setAttribute(<span class="literal">'height'</span>, imgh);}
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onLoadImage'</span>, <span class="reserved">this</span>.pic);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (typeof img == <span class="literal">'object'</span>) {
		<span class="comment">//we have to use the src of the image object</span>
		var src = img.src; <span class="comment">//img.getAttribute('src');</span>
		<span class="reserved">if</span> (src === <span class="literal">''</span> &amp;&amp; img.getAttribute(<span class="literal">'mce_src'</span>) !== <span class="literal">''</span>) {
			<span class="comment">//if it is a tinymce object, it has no src but mce_src attribute!</span>
			src = img.getAttribute(<span class="literal">'mce_src'</span>);
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (src === <span class="literal">''</span> &amp;&amp; img.getAttribute(<span class="literal">'_fcksavedurl'</span>) !== <span class="literal">''</span>) {
			<span class="comment">//if it is an fck object, it might have only _fcksavedurl attribute!</span>
			src = img.getAttribute(<span class="literal">'_fcksavedurl'</span>);
		}
		<span class="comment">// Get the displayed dimensions of the image</span>
		<span class="reserved">if</span> (!imgw) {
			imgw = img.clientWidth;
		}
		<span class="reserved">if</span> (!imgh) {
			imgh = img.clientHeight;
		}
		<span class="reserved">this</span>.loadImage(src, imgw, imgh);
	}
};


<span class="comment">/**
 *	We use this when there is an existing image object we want to handle with imgmap.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@date</span>	2007
 *	<span class="attrib">@param</span>	img	DOM object or id of image we want to use.
 */</span>
imgmap.<span class="reserved">prototype</span>.useImage = <span class="reserved">function</span>(img) {
	<span class="comment">//wipe all</span>
	<span class="reserved">this</span>.removeAllAreas();
	<span class="reserved">if</span> (!<span class="reserved">this</span>._getLastArea()) {
		<span class="comment">//init with one new area if there was none editable</span>
		<span class="reserved">if</span> (<span class="reserved">this</span>.config.mode != <span class="literal">"editor2"</span>) {<span class="reserved">this</span>.addNewArea();}
	}
	img = <span class="reserved">this</span>.assignOID(img);
	<span class="reserved">if</span> (typeof img == <span class="literal">'object'</span>) {
		<span class="reserved">this</span>.pic = img;
		<span class="comment">//event handler hooking</span>
		<span class="reserved">this</span>.addEvent(<span class="reserved">this</span>.pic, <span class="literal">'mousedown'</span>, <span class="reserved">this</span>.img_mousedown.bind(<span class="reserved">this</span>));
		<span class="reserved">this</span>.addEvent(<span class="reserved">this</span>.pic, <span class="literal">'mouseup'</span>,   <span class="reserved">this</span>.img_mouseup.bind(<span class="reserved">this</span>));
		<span class="reserved">this</span>.addEvent(<span class="reserved">this</span>.pic, <span class="literal">'mousemove'</span>, <span class="reserved">this</span>.img_mousemove.bind(<span class="reserved">this</span>));
		<span class="reserved">this</span>.pic.style.cursor = <span class="reserved">this</span>.config.cursor_default;
		<span class="reserved">this</span>.pic_container = <span class="reserved">this</span>.pic.parentNode;
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onLoadImage'</span>, <span class="reserved">this</span>.pic);
	}
};


<span class="comment">/**
 *	Fires custom hook onStatusMessage, passing the status string.
 *	Use this to update your GUI. 
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	26-07-2008 13:22:54
 *	<span class="attrib">@param</span>	str	The status string
 */</span>
imgmap.<span class="reserved">prototype</span>.statusMessage = <span class="reserved">function</span>(str) {
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onStatusMessage'</span>, str);
};


<span class="comment">/**
 *	Adds basic logging functionality using firebug console object if available.
 *	Also tries to use AIR introspector if available. 
 *	<span class="attrib">@date</span>	20-02-2007 17:55:18
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@param</span>	obj	The object or string you want to debug/echo.
 *	<span class="attrib">@level</span>	level	The log level, 0 being the smallest issue.  
 */</span>
imgmap.<span class="reserved">prototype</span>.log = <span class="reserved">function</span>(obj, level) {
	<span class="reserved">if</span> (level === <span class="literal">''</span> || typeof level == <span class="literal">'undefined'</span>) {level = 0;}
	<span class="reserved">if</span> (<span class="reserved">this</span>.config.loglevel != -1 &amp;&amp; level &gt;= <span class="reserved">this</span>.config.loglevel) {
		<span class="reserved">this</span>.logStore.push({level: level, obj: obj});
	}
	<span class="reserved">if</span> (typeof console == <span class="literal">'object'</span>) {
		console.log(obj);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.isOpera) {
		opera.postError(level + <span class="literal">': '</span> + obj);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (typeof air == <span class="literal">'object'</span>) {
		<span class="comment">//we are inside AIR</span>
		<span class="reserved">if</span> (typeof air.Introspector == <span class="literal">'object'</span>) {
			air.Introspector.Console.log(obj);
		}
	<span class="reserved">else</span> {
			air.trace(obj);
		}
	}
	<span class="reserved">else</span> {
		<span class="reserved">if</span> (level &gt; 1) {
			<span class="comment">//alert(level + ': ' + obj);</span>
			<span class="comment">//dump with all pevious errors:</span>
			var msg = <span class="literal">''</span>;
			<span class="reserved">for</span> (var i=0; i&lt;<span class="reserved">this</span>.logStore.length; i++) {
				msg+= <span class="reserved">this</span>.logStore[i].level + <span class="literal">': '</span> + <span class="reserved">this</span>.logStore[i].obj + <span class="literal">"\n"</span>;
			}
			alert(msg);
		}
		<span class="reserved">else</span> {
			window.defaultStatus = (level + <span class="literal">': '</span> + obj);
		}
	}
};


<span class="comment">/**
 *	Produces the image map HTML output with the defined areas.
 *	Invokes getMapInnerHTML. 
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	2006-06-06 15:10:27
 *	<span class="attrib">@return</span> The generated html code. 
 */</span>
imgmap.<span class="reserved">prototype</span>.getMapHTML = <span class="reserved">function</span>() {
	var html = <span class="literal">'&lt;map id="'</span>+<span class="reserved">this</span>.getMapId()+<span class="literal">'" name="'</span>+<span class="reserved">this</span>.getMapName()+<span class="literal">'"&gt;'</span> + <span class="reserved">this</span>.getMapInnerHTML() + <span class="reserved">this</span>.waterMark + <span class="literal">'&lt;/map&gt;'</span>;
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onGetMap'</span>, html);
	<span class="comment">//alert(html);</span>
	<span class="reserved">return</span> html;
};


<span class="comment">/**
 *	Get the map areas part only of the current imagemap.
 *	<span class="attrib">@see</span>	#getMapHTML 
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@return</span>	The generated map code without the map wrapper.  
 */</span>
imgmap.<span class="reserved">prototype</span>.getMapInnerHTML = <span class="reserved">function</span>() {
	var html = <span class="literal">''</span>;
	<span class="comment">//foreach area properties</span>
	<span class="reserved">for</span> (var i=0; i&lt;<span class="reserved">this</span>.areas.length; i++) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i]) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i].shape &amp;&amp; <span class="reserved">this</span>.areas[i].shape != <span class="literal">'undefined'</span>) {
					html+= <span class="literal">'&lt;area shape="'</span> + <span class="reserved">this</span>.areas[i].shape + <span class="literal">'"'</span> +
						<span class="literal">' alt="'</span> + <span class="reserved">this</span>.areas[i].aalt + <span class="literal">'"'</span> +
						<span class="literal">' title="'</span> + <span class="reserved">this</span>.areas[i].atitle + <span class="literal">'"'</span> +
						<span class="literal">' coords="'</span> + <span class="reserved">this</span>.areas[i].lastInput + <span class="literal">'"'</span> +
						<span class="literal">' href="'</span> +	<span class="reserved">this</span>.areas[i].ahref + <span class="literal">'"'</span> +
						<span class="literal">' target="'</span> + <span class="reserved">this</span>.areas[i].atarget + <span class="literal">'" /&gt;'</span>;
			}
		}
	}
	<span class="comment">//alert(html);</span>
	<span class="reserved">return</span> html;
};


<span class="comment">/**
 *	Get the map name of the current imagemap.
 *	If doesnt exist, nor map id, generate a new name based on timestamp.
 *	The most portable solution is to use the same value for id and name.
 *	This also conforms the HTML 5 specification, that says:
 *	"If the id  attribute is also specified, both attributes must have the same value."   
 *	<span class="attrib">@link</span>	http://www.w3.org/html/wg/html5/#the-map-element
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@see</span>	#getMapId
 *	<span class="attrib">@return</span> The name of the map.
 */</span>
imgmap.<span class="reserved">prototype</span>.getMapName = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.mapname === <span class="literal">''</span>) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.mapid !== <span class="literal">''</span>) {<span class="reserved">return</span> <span class="reserved">this</span>.mapid;}
		var now = new Date();
		<span class="reserved">this</span>.mapname = <span class="literal">'imgmap'</span> + now.getFullYear() + (now.getMonth()+1) + now.getDate() + now.getHours() + now.getMinutes() + now.getSeconds();
	}
	<span class="reserved">return</span> <span class="reserved">this</span>.mapname;
};


<span class="comment">/**
 *	Get the map id of the current imagemap.
 *	If doesnt exist, use map name.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@see</span>	#getMapName
 *	<span class="attrib">@return</span>	The id of the map.    
 */</span>
imgmap.<span class="reserved">prototype</span>.getMapId = <span class="reserved">function</span>() {
	<span class="reserved">if</span> (<span class="reserved">this</span>.mapid === <span class="literal">''</span>) {
		<span class="reserved">this</span>.mapid = <span class="reserved">this</span>.getMapName();
	}
	<span class="reserved">return</span> <span class="reserved">this</span>.mapid;
};


<span class="comment">/**
 *	Try to normalize coordinates that came from:
 *	1. html textarea
 *	2. user input in the active area's input field
 *	3. from the html source in case of plugins or highlighter
 *	Example of inputs that need to be handled:
 *		035,035 075,062
 *		150,217, 190,257, 150,297,110,257
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	coords	The coordinates in a string.
 *	<span class="attrib">@param</span>	shape	The shape of the object (rect, circle, poly).
 *	<span class="attrib">@param</span>	flag	Flags that modify the operation. (fromcircle, frompoly, fromrect, preserve)
 *	<span class="attrib">@returns</span> The normalized coordinates. 
 */</span>
imgmap.<span class="reserved">prototype</span>._normCoords = <span class="reserved">function</span>(coords, shape, flag) {
	<span class="comment">//function level var declarations</span>
	var i;<span class="comment">//generic cycle counter</span>
	var sx;<span class="comment">//smallest x</span>
	var sy;<span class="comment">//smallest y</span>
	var gx;<span class="comment">//greatest x</span>
	var gy;<span class="comment">//greatest y</span>
	var temp;
	
	<span class="comment">//console.log(coords + ' - ' + shape + ' - ' + flag);</span>
	coords = coords.trim();
	<span class="reserved">if</span> (coords === <span class="literal">''</span>) {<span class="reserved">return</span> <span class="literal">''</span>;}
	var oldcoords = coords;
	<span class="comment">//replace some general junk</span>
	coords = coords.replace(/(\d)(\D)+(\d)/g, <span class="literal">"$1,$3"</span>);
	coords = coords.replace(/,(\D|0)+(\d)/g, <span class="literal">",$2"</span>);
	coords = coords.replace(/(\d)(\D)+,/g, <span class="literal">"$1,"</span>);
	coords = coords.replace(/^(\D|0)+(\d)/g, <span class="literal">"$2"</span>);
	<span class="comment">//now fix other issues</span>
	var parts = coords.split(<span class="literal">','</span>);
	<span class="reserved">if</span> (shape == <span class="literal">'rect'</span>) {
		<span class="reserved">if</span> (flag == <span class="literal">'fromcircle'</span>) {
			var r = parts[2];
			parts[0] = parts[0] - r;
			parts[1] = parts[1] - r;
			parts[2] = parseInt(parts[0], 10) + 2 * r;
			parts[3] = parseInt(parts[1], 10) + 2 * r;
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (flag == <span class="literal">'frompoly'</span>) {
			sx = parseInt(parts[0], 10); gx = parseInt(parts[0], 10);
			sy = parseInt(parts[1], 10); gy = parseInt(parts[1], 10);
			<span class="reserved">for</span> (i=0; i&lt;parts.length; i++) {
				<span class="reserved">if</span> (i % 2 === 0 &amp;&amp; parseInt(parts[i], 10) &lt; sx) {
					sx = parseInt(parts[i], 10);}
				<span class="reserved">if</span> (i % 2 === 1 &amp;&amp; parseInt(parts[i], 10) &lt; sy) {
					sy = parseInt(parts[i], 10);}
				<span class="reserved">if</span> (i % 2 === 0 &amp;&amp; parseInt(parts[i], 10) &gt; gx) {
					gx = parseInt(parts[i], 10);}
				<span class="reserved">if</span> (i % 2 === 1 &amp;&amp; parseInt(parts[i], 10) &gt; gy) {
					gy = parseInt(parts[i], 10);}
				<span class="comment">//console.log(sx+","+sy+","+gx+","+gy);</span>
			}
			parts[0] = sx; parts[1] = sy;
			parts[2] = gx; parts[3] = gy;
		}
		<span class="reserved">if</span> (!(parseInt(parts[1], 10) &gt; 0)) {parts[1] = parts[0];}
		<span class="reserved">if</span> (!(parseInt(parts[2], 10) &gt; 0)) {parts[2] = parseInt(parts[0], 10) + 10;}
		<span class="reserved">if</span> (!(parseInt(parts[3], 10) &gt; 0)) {parts[3] = parseInt(parts[1], 10) + 10;}
		<span class="reserved">if</span> (parseInt(parts[0], 10) &gt; parseInt(parts[2], 10)) {
			temp = parts[0];
			parts[0] = parts[2];
			parts[2] = temp;
		}
		<span class="reserved">if</span> (parseInt(parts[1], 10) &gt; parseInt(parts[3], 10)) {
			temp = parts[1];
			parts[1] = parts[3];
			parts[3] = temp;
		}
		coords = parts[0]+<span class="literal">","</span>+parts[1]+<span class="literal">","</span>+parts[2]+<span class="literal">","</span>+parts[3];
		<span class="comment">//console.log(coords);</span>
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (shape == <span class="literal">'circle'</span>) {
		<span class="reserved">if</span> (flag == <span class="literal">'fromrect'</span>) {
			sx = parseInt(parts[0], 10); gx = parseInt(parts[2], 10);
			sy = parseInt(parts[1], 10); gy = parseInt(parts[3], 10);
			<span class="comment">//use smaller side</span>
			parts[2] = (gx - sx &lt; gy - sy) ? gx - sx : gy - sy;
			parts[2] = Math.floor(parts[2] / 2);<span class="comment">//radius</span>
			parts[0] = sx + parts[2];
			parts[1] = sy + parts[2];
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (flag == <span class="literal">'frompoly'</span>) {
			sx = parseInt(parts[0], 10); gx = parseInt(parts[0], 10);
			sy = parseInt(parts[1], 10); gy = parseInt(parts[1], 10);
			<span class="reserved">for</span> (i=0; i&lt;parts.length; i++) {
				<span class="reserved">if</span> (i % 2 === 0 &amp;&amp; parseInt(parts[i], 10) &lt; sx) {
					sx = parseInt(parts[i], 10);}
				<span class="reserved">if</span> (i % 2 === 1 &amp;&amp; parseInt(parts[i], 10) &lt; sy) {
					sy = parseInt(parts[i], 10);}
				<span class="reserved">if</span> (i % 2 === 0 &amp;&amp; parseInt(parts[i], 10) &gt; gx) {
					gx = parseInt(parts[i], 10);}
				<span class="reserved">if</span> (i % 2 === 1 &amp;&amp; parseInt(parts[i], 10) &gt; gy) {
					gy = parseInt(parts[i], 10);}
				<span class="comment">//console.log(sx+","+sy+","+gx+","+gy);</span>
			}
			<span class="comment">//use smaller side</span>
			parts[2] = (gx - sx &lt; gy - sy) ? gx - sx : gy - sy;
			parts[2] = Math.floor(parts[2] / 2);<span class="comment">//radius</span>
			parts[0] = sx + parts[2];
			parts[1] = sy + parts[2];
		}
		<span class="reserved">if</span> (!(parseInt(parts[1], 10) &gt; 0)) {parts[1] = parts[0];}
		<span class="reserved">if</span> (!(parseInt(parts[2], 10) &gt; 0)) {parts[2] = 10;}
		coords = parts[0]+<span class="literal">","</span>+parts[1]+<span class="literal">","</span>+parts[2];
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (shape == <span class="literal">'poly'</span>) {
		<span class="reserved">if</span> (flag == <span class="literal">'fromrect'</span>) {
			parts[4] = parts[2];
			parts[5] = parts[3];
			parts[2] = parts[0];
			parts[6] = parts[4];
			parts[7] = parts[1];
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (flag == <span class="literal">'fromcircle'</span>) {
			<span class="comment">//<span class="attrib">@url</span> http://www.pixelwit.com/blog/2007/06/29/basic-circle-drawing-actionscript/</span>
			var centerX = parseInt(parts[0], 10);
			var centerY = parseInt(parts[1], 10);
			var radius  = parseInt(parts[2], 10);
			var j = 0;
			parts[j++] = centerX + radius;
			parts[j++] = centerY;
			var sides = 60;
			<span class="reserved">for</span> (i=0; i&lt;=sides; i++) {
				var pointRatio = i/sides;
				var xSteps = Math.cos(pointRatio*2*Math.PI);
				var ySteps = Math.sin(pointRatio*2*Math.PI);
				var pointX = centerX + xSteps * radius;
				var pointY = centerY + ySteps * radius;
				parts[j++] = Math.round(pointX);
				parts[j++] = Math.round(pointY);
			}
			<span class="comment">//console.log(parts);</span>
		}
		coords = <span class="literal">''</span>;
		<span class="reserved">for</span> (i=0; i&lt;parts.length; i++) {
			coords+= parts[i]+<span class="literal">","</span>;
		}
		coords = coords.substring(0, coords.length - 1);
	}
	<span class="reserved">if</span> (flag == <span class="literal">'preserve'</span> &amp;&amp; oldcoords != coords) {
		<span class="comment">//return original and throw error</span>
		<span class="comment">//throw "invalid coords";</span>
		<span class="reserved">return</span> oldcoords;
	}
	<span class="reserved">return</span> coords;
};


<span class="comment">/**
 *	Sets the coordinates according to the given HTML map code or DOM object.
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	2006-06-07 11:47:16
 *	<span class="attrib">@param</span>	map	DOM object or string of a map you want to apply. 
 */</span>   
imgmap.<span class="reserved">prototype</span>.setMapHTML = <span class="reserved">function</span>(map) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onSetMap'</span>, map);
	<span class="comment">//this.log(map);</span>
	<span class="comment">//remove all areas</span>
	<span class="reserved">this</span>.removeAllAreas();
	<span class="comment">//console.log(this.areas);</span>
	
	var oMap;
	<span class="reserved">if</span> (typeof map == <span class="literal">'string'</span>) {
		var oHolder = document.createElement(<span class="literal">'DIV'</span>);
		oHolder.innerHTML = map;
		oMap = oHolder.firstChild;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (typeof map == <span class="literal">'object'</span>) {
		oMap = map;
	}
	<span class="reserved">if</span> (!oMap || oMap.nodeName.toLowerCase() !== <span class="literal">'map'</span>) {<span class="reserved">return</span> false;}
	<span class="reserved">this</span>.mapname = oMap.name;
	<span class="reserved">this</span>.mapid   = oMap.id;
	var newareas = oMap.getElementsByTagName(<span class="literal">'area'</span>);
	var shape, coords, href, alt, title, target;
	<span class="reserved">for</span> (var i=0; i&lt;newareas.length; i++) {
		shape = coords = href = alt = title = target = <span class="literal">''</span>;
		
		id = <span class="reserved">this</span>.addNewArea();<span class="comment">//btw id == this.currentid, just this form is a bit clearer</span>

		<span class="reserved">if</span> (newareas[i].getAttribute(<span class="literal">'shape'</span>, 2)) {
			shape = newareas[i].getAttribute(<span class="literal">'shape'</span>, 2);
		}
		<span class="reserved">else</span> {
			shape = <span class="literal">'rect'</span>;
		} 

		<span class="reserved">this</span>.initArea(id, shape);
		
		<span class="reserved">if</span> (newareas[i].getAttribute(<span class="literal">'coords'</span>, 2)) {
			<span class="comment">//normalize coords</span>
			coords = <span class="reserved">this</span>._normCoords(newareas[i].getAttribute(<span class="literal">'coords'</span>, 2), shape);
			<span class="reserved">this</span>.areas[id].lastInput = coords;
			<span class="comment">//for area this one will be set in recalculate</span>
		}

		href = newareas[i].getAttribute(<span class="literal">'href'</span>, 2);
		<span class="comment">// FCKeditor stored url to prevent mangling from the browser.</span>
		var sSavedUrl = newareas[i].getAttribute( <span class="literal">'_fcksavedurl'</span> );
		<span class="reserved">if</span> (sSavedUrl) {
			href = sSavedUrl;
		}
		<span class="reserved">if</span> (href) {
			<span class="reserved">this</span>.areas[id].ahref = href;
		}
		
		alt = newareas[i].getAttribute(<span class="literal">'alt'</span>);
		<span class="reserved">if</span> (alt) {
			<span class="reserved">this</span>.areas[id].aalt = alt;
		}
		
		title = newareas[i].getAttribute(<span class="literal">'title'</span>);
		<span class="reserved">if</span> (!title) {title = alt;}
		<span class="reserved">if</span> (title) {
			<span class="reserved">this</span>.areas[id].atitle = title;
		}

		target = newareas[i].getAttribute(<span class="literal">'target'</span>);
		<span class="reserved">if</span> (target) {target = target.toLowerCase();}
<span class="comment">//		if (target == '') target = '_self';</span>
		<span class="reserved">this</span>.areas[id].atarget = target;
		
		<span class="reserved">this</span>._recalculate(id, coords);<span class="comment">//contains repaint</span>
		<span class="reserved">this</span>.relaxArea(id);
		
		var obj = {}; obj[id] = {};
		obj[id].shape  = shape;
		obj[id].coords = coords;
		obj[id].href   = href;
		obj[id].alt    = alt;
		obj[id].title  = title;
		obj[id].target = target;
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onAreaChanged'</span>, obj);
		
	}<span class="comment">//end for areas</span>
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onHtmlChanged'</span>, <span class="reserved">this</span>.getMapHTML());
};


<span class="comment">/**
 *	Preview image with imagemap applied.
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	2006-06-06 14:51:01
 *	<span class="attrib">@url</span>	http://www.quirksmode.org/bugreports/archives/2005/03/Usemap_attribute_wrongly_case_sensitive.html 
 */</span>
imgmap.<span class="reserved">prototype</span>.togglePreview = <span class="reserved">function</span>() {
	var i;<span class="comment">//generic cycle counter</span>
	
	<span class="reserved">if</span> (!<span class="reserved">this</span>.pic) {<span class="reserved">return</span> false;}<span class="comment">//exit if pic is undefined</span>
	
	<span class="comment">//dynamically create preview container</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.preview) {
		<span class="reserved">this</span>.preview = document.createElement(<span class="literal">'DIV'</span>);
		<span class="reserved">this</span>.preview.style.display = <span class="literal">'none'</span>;
		<span class="reserved">this</span>.pic.parentNode.appendChild(<span class="reserved">this</span>.preview);
	}
	
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 0) {
		<span class="comment">//hide canvas elements and labels</span>
		<span class="reserved">for</span> (i=0; i&lt;<span class="reserved">this</span>.areas.length; i++) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i]) {
				<span class="reserved">this</span>.areas[i].style.display = <span class="literal">'none'</span>;
				<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i].label) {<span class="reserved">this</span>.areas[i].label.style.display = <span class="literal">'none'</span>;}
			}
		}
		<span class="comment">//activate image map</span>
		<span class="reserved">this</span>.preview.innerHTML = <span class="reserved">this</span>.getMapHTML();
		<span class="reserved">this</span>.pic.setAttribute(<span class="literal">'border'</span>, <span class="literal">'0'</span>, 0);
		<span class="reserved">this</span>.pic.setAttribute(<span class="literal">'usemap'</span>, <span class="literal">'#'</span> + <span class="reserved">this</span>.mapname, 0);
		<span class="reserved">this</span>.pic.style.cursor  = <span class="literal">'auto'</span>;
		<span class="reserved">this</span>.viewmode = 1;
		<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.PREVIEW_MODE);
	}
	<span class="reserved">else</span> {
		<span class="comment">//show canvas elements</span>
		<span class="reserved">for</span> (i=0; i&lt;<span class="reserved">this</span>.areas.length; i++) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i]) {
				<span class="reserved">this</span>.areas[i].style.display = <span class="literal">''</span>;
				<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i].label &amp;&amp; <span class="reserved">this</span>.config.label) {<span class="reserved">this</span>.areas[i].label.style.display = <span class="literal">''</span>;}
			}
		}
		<span class="comment">//clear image map</span>
		<span class="reserved">this</span>.preview.innerHTML = <span class="literal">''</span>;
		<span class="reserved">this</span>.pic.style.cursor  = <span class="reserved">this</span>.config.cursor_default;
		<span class="reserved">this</span>.pic.removeAttribute(<span class="literal">'usemap'</span>, 0);
		<span class="reserved">this</span>.viewmode = 0;
		<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.DESIGN_MODE);
		<span class="reserved">this</span>.is_drawing = 0;
	}
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onModeChanged'</span>, <span class="reserved">this</span>.viewmode);
	<span class="reserved">return</span> <span class="reserved">this</span>.viewmode;
};


<span class="comment">/**
 *	Adds a new area. It will later become a canvas.
 *	Gui should use the onAddArea callback to act accordingly.
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	2006-06-06 16:49:25
 *	<span class="attrib">@see</span>	#initArea
 */</span>
imgmap.<span class="reserved">prototype</span>.addNewArea = <span class="reserved">function</span>() {
		<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
		var lastarea = <span class="reserved">this</span>._getLastArea();
		var id = (lastarea) ? lastarea.aid + 1 : 0;
		<span class="comment">//alert(id);</span>
		
		<span class="comment">//insert new possibly? unknown area (will be initialized at mousedown)</span>
		<span class="reserved">this</span>.areas[id] = document.createElement(<span class="literal">'DIV'</span>);
		<span class="reserved">this</span>.areas[id].id        = <span class="reserved">this</span>.mapname + <span class="literal">'area'</span> + id;
		<span class="reserved">this</span>.areas[id].aid       = id;
		<span class="reserved">this</span>.areas[id].shape     = <span class="literal">"undefined"</span>;
		
		<span class="reserved">this</span>.currentid = id;
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onAddArea'</span>, id);
		<span class="reserved">return</span> id;
};


<span class="comment">/**
 *	Initialize a new area.
 *	Create the canvas, initialize it.
 *	Reset area parameters.
 *	<span class="attrib">@param</span>	id	The id of the area (already existing with undefined shape)
 *	<span class="attrib">@param</span>	shape	The shape the area will have (rect, circle, poly)
 */</span>
imgmap.<span class="reserved">prototype</span>.initArea = <span class="reserved">function</span>(id, shape) {
	<span class="reserved">if</span> (!<span class="reserved">this</span>.areas[id]) {<span class="reserved">return</span> false;}<span class="comment">//if all was erased, return</span>
	<span class="comment">//remove preinited dummy div or already placed canvas</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].parentNode) {<span class="reserved">this</span>.areas[id].parentNode.removeChild(<span class="reserved">this</span>.areas[id]);}
	<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].label) {<span class="reserved">this</span>.areas[id].label.parentNode.removeChild(<span class="reserved">this</span>.areas[id].label);}
	<span class="reserved">this</span>.areas[id] = null;
	<span class="comment">//create CANVAS node</span>
	<span class="reserved">this</span>.areas[id] = document.createElement(<span class="literal">'CANVAS'</span>);
	<span class="reserved">this</span>.pic.parentNode.appendChild(<span class="reserved">this</span>.areas[id]);
	<span class="reserved">this</span>.pic.parentNode.style.position = <span class="literal">'relative'</span>;
	<span class="comment">//alert('init' + typeof G_vmlCanvasManager);</span>
	<span class="reserved">if</span> (typeof G_vmlCanvasManager != <span class="literal">"undefined"</span>) {
		<span class="comment">//override CANVAS with VML object</span>
		<span class="reserved">this</span>.areas[id] = G_vmlCanvasManager.initElement(<span class="reserved">this</span>.areas[id]);
		<span class="comment">//this.areas[id] = this.pic.parentNode.lastChild;</span>
	}
	<span class="reserved">this</span>.areas[id].id        = <span class="reserved">this</span>.mapname + <span class="literal">'area'</span> + id;
	<span class="reserved">this</span>.areas[id].aid       = id;
	<span class="reserved">this</span>.areas[id].shape     = shape;
	<span class="reserved">this</span>.areas[id].ahref     = <span class="literal">''</span>;
	<span class="reserved">this</span>.areas[id].atitle    = <span class="literal">''</span>;
	<span class="reserved">this</span>.areas[id].aalt      = <span class="literal">''</span>;
	<span class="reserved">this</span>.areas[id].atarget   = <span class="literal">''</span>; <span class="comment">// '_self';</span>
	<span class="reserved">this</span>.areas[id].style.position = <span class="literal">'absolute'</span>;
	<span class="reserved">this</span>.areas[id].style.top      = <span class="reserved">this</span>.pic.offsetTop  + <span class="literal">'px'</span>;
	<span class="reserved">this</span>.areas[id].style.left     = <span class="reserved">this</span>.pic.offsetLeft + <span class="literal">'px'</span>;
	<span class="reserved">this</span>._setopacity(<span class="reserved">this</span>.areas[id], <span class="reserved">this</span>.config.CL_DRAW_BG, <span class="reserved">this</span>.config.draw_opacity);
	<span class="comment">//hook event handlers</span>
	<span class="reserved">this</span>.areas[id].onmousedown = <span class="reserved">this</span>.area_mousedown.bind(<span class="reserved">this</span>);
	<span class="reserved">this</span>.areas[id].onmouseup   = <span class="reserved">this</span>.area_mouseup.bind(<span class="reserved">this</span>);
	<span class="reserved">this</span>.areas[id].onmousemove = <span class="reserved">this</span>.area_mousemove.bind(<span class="reserved">this</span>);
	<span class="reserved">this</span>.areas[id].onmouseover = <span class="reserved">this</span>.area_mouseover.bind(<span class="reserved">this</span>);
	<span class="reserved">this</span>.areas[id].onmouseout  = <span class="reserved">this</span>.area_mouseout.bind(<span class="reserved">this</span>);
	<span class="comment">//initialize memory object</span>
	<span class="reserved">this</span>.memory[id] = {};
	<span class="reserved">this</span>.memory[id].downx   = 0;
	<span class="reserved">this</span>.memory[id].downy   = 0;
	<span class="reserved">this</span>.memory[id].left    = 0;
	<span class="reserved">this</span>.memory[id].top     = 0;
	<span class="reserved">this</span>.memory[id].width   = 0;
	<span class="reserved">this</span>.memory[id].height  = 0;
	<span class="reserved">this</span>.memory[id].xpoints = [];
	<span class="reserved">this</span>.memory[id].ypoints = [];
	<span class="comment">//create label node</span>
	<span class="reserved">this</span>.areas[id].label = document.createElement(<span class="literal">'DIV'</span>);
	<span class="reserved">this</span>.pic.parentNode.appendChild(<span class="reserved">this</span>.areas[id].label);
	<span class="reserved">this</span>.areas[id].label.className      = <span class="reserved">this</span>.config.label_class;
	<span class="reserved">this</span>.assignCSS(<span class="reserved">this</span>.areas[id].label,  <span class="reserved">this</span>.config.label_style);
	<span class="reserved">this</span>.areas[id].label.style.position = <span class="literal">'absolute'</span>;
};


<span class="comment">/**
 *	Resets area border to a normal state after drawing.
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	15-02-2007 22:07:28
 *	<span class="attrib">@param</span>	id	The id of the area. 
 *	<span class="attrib">@see</span>	#relaxAllAreas
 */</span>
imgmap.<span class="reserved">prototype</span>.relaxArea = <span class="reserved">function</span>(id) {
	<span class="reserved">if</span> (!<span class="reserved">this</span>.areas[id]) {<span class="reserved">return</span>;}
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onRelaxArea'</span>, id);
	<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'rect'</span>) {
		<span class="reserved">this</span>.areas[id].style.borderWidth = <span class="literal">'1px'</span>;
		<span class="reserved">this</span>.areas[id].style.borderStyle = <span class="literal">'solid'</span>;
		<span class="reserved">this</span>.areas[id].style.borderColor = <span class="reserved">this</span>.config.CL_NORM_SHAPE;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'circle'</span> || <span class="reserved">this</span>.areas[id].shape == <span class="literal">'poly'</span>) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
			<span class="reserved">this</span>.areas[id].style.borderWidth = <span class="literal">'1px'</span>;
			<span class="reserved">this</span>.areas[id].style.borderStyle = <span class="literal">'solid'</span>;
			<span class="reserved">this</span>.areas[id].style.borderColor = <span class="reserved">this</span>.config.CL_NORM_BOX;
		}
		<span class="reserved">else</span> {
			<span class="comment">//clear border</span>
			<span class="reserved">this</span>.areas[id].style.border = <span class="literal">''</span>;
		}
	}
	<span class="reserved">this</span>._setopacity(<span class="reserved">this</span>.areas[id], <span class="reserved">this</span>.config.CL_NORM_BG, <span class="reserved">this</span>.config.norm_opacity);
};


<span class="comment">/**
 *	Resets area border and opacity of all areas.
 *	Calls relaxArea on each of them. 
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	23-04-2007 23:31:09
 *	<span class="attrib">@see</span>	#relaxArea
 */</span>
imgmap.<span class="reserved">prototype</span>.relaxAllAreas = <span class="reserved">function</span>() {
	<span class="reserved">for</span> (var i=0; i&lt;<span class="reserved">this</span>.areas.length; i++) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i]) {
			<span class="reserved">this</span>.relaxArea(i);
		}
	}
};


<span class="comment">/**
 *	Set opacity of area to the given percentage, as well as set the background color.
 *	If percentage contains a dash(-), the setting of the opacity will be gradual. 
 *	<span class="attrib">@param</span>	area	The area object.
 *	<span class="attrib">@param</span>	bgcolor	New background color
 *	<span class="attrib">@param</span>	pct		Percentage of the opacity.   
 */</span>
imgmap.<span class="reserved">prototype</span>._setopacity = <span class="reserved">function</span>(area, bgcolor, pct) {
	<span class="reserved">if</span> (bgcolor) {area.style.backgroundColor = bgcolor;}
	<span class="reserved">if</span> (pct &amp;&amp; typeof pct == <span class="literal">'string'</span> &amp;&amp; pct.match(/^\d*\-\d+$/)) {
		<span class="comment">//gradual fade</span>
		var parts = pct.split(<span class="literal">'-'</span>);
		<span class="reserved">if</span> (typeof parts[0] != <span class="literal">'undefined'</span>) {
			<span class="comment">//set initial opacity</span>
			parts[0] = parseInt(parts[0], 10);
			<span class="reserved">this</span>._setopacity(area, bgcolor, parts[0]);
		}
		<span class="reserved">if</span> (typeof parts[1] != <span class="literal">'undefined'</span>) {
			parts[1] = parseInt(parts[1], 10);
			var curr = <span class="reserved">this</span>._getopacity(area);
			<span class="comment">//this.log('curr: '+curr);</span>
			var _this = <span class="reserved">this</span>;
			var diff = Math.round(parts[1] - curr);
			<span class="reserved">if</span> (diff &gt; 5) {
				window.setTimeout(<span class="reserved">function</span> () {_this._setopacity(area, null, <span class="literal">'-'</span>+parts[1]);}, 20);
				pct = 1*curr + 5;
			}
			<span class="reserved">else</span> <span class="reserved">if</span> (diff &lt; -3) {
				window.setTimeout(<span class="reserved">function</span> () {_this._setopacity(area, null, <span class="literal">'-'</span>+parts[1]);}, 20);
				pct = 1*curr - 3;
			}
			<span class="reserved">else</span> {
				<span class="comment">//final set</span>
				pct = parts[1];
			}
		}
	}
	<span class="reserved">if</span> (!isNaN(pct)) {
		pct = Math.round(parseInt(pct, 10));
		<span class="comment">//this.log('set ('+area.aid+'): ' + pct, 1);</span>
		area.style.opacity = pct / 101;
		area.style.filter  = <span class="literal">'alpha(opacity='</span>+pct+<span class="literal">')'</span>;
	}
};


<span class="comment">/**
 *	Get the currently set opacity of a given area.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	area	The area (canvas) you want to get opacity info from.
 *	<span class="attrib">@return</span>	Opacity value in a range of 0-100.   
 */</span>
imgmap.<span class="reserved">prototype</span>._getopacity = <span class="reserved">function</span>(area) {
	<span class="reserved">if</span> (area.style.opacity &lt;= 1) {
		<span class="reserved">return</span> area.style.opacity * 100;
	}
	<span class="reserved">if</span> (area.style.filter) {
		<span class="comment">//alpha(opacity=NaN)</span>
		<span class="reserved">return</span> parseInt(area.style.filter.replace(/alpha\(opacity\=([^\)]*)\)/ig, <span class="literal">"$1"</span>), 10);	
	}
	<span class="reserved">return</span> 100;<span class="comment">//default opacity</span>
};


<span class="comment">/**
 *	Removes the area marked by id.
 *	removeAllAreas will indicate a mass flag so that the output HTML will only be updated at 
 *	the end of the operation.
 *	Callback will call the gui code to remove gui elements. 
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	11-02-2007 20:40:58
 *	<span class="attrib">@param</span>	id	The id of the area to remove.
 *	<span class="attrib">@param</span>	mass	Flag to indicate skipping the call of onHtmlChanged callback
 *	<span class="attrib">@see</span>	#removeAllAreas
 */</span>
imgmap.<span class="reserved">prototype</span>.removeArea = <span class="reserved">function</span>(id, mass) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="reserved">if</span> (id === null || typeof id == <span class="literal">"undefined"</span>) {<span class="reserved">return</span>;}<span class="comment">//exit if no id given</span>

	try {
		<span class="comment">//remove area and label</span>
		<span class="comment">//explicitly set some values to null to avoid IE circular reference memleak </span>
		<span class="reserved">this</span>.areas[id].label.parentNode.removeChild(<span class="reserved">this</span>.areas[id].label);
		<span class="reserved">this</span>.areas[id].parentNode.removeChild(<span class="reserved">this</span>.areas[id]);
		<span class="reserved">this</span>.areas[id].label.className = null;
		<span class="comment">//this.areas[id].label.style = null;</span>
		<span class="comment">//console.log(this.areas[id].label);</span>
		<span class="reserved">this</span>.areas[id].label       = null;
		<span class="reserved">this</span>.areas[id].onmouseover = null;
		<span class="reserved">this</span>.areas[id].onmouseout  = null;
		<span class="reserved">this</span>.areas[id].onmouseup   = null;
		<span class="reserved">this</span>.areas[id].onmousedown = null;
		<span class="reserved">this</span>.areas[id].onmousemove = null;
<span class="comment">//		console.log(this.areas[id].label);</span>
		
	}
	catch (err) {
		<span class="comment">//alert('noparent');</span>
	}
	<span class="reserved">this</span>.areas[id] = null;
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onRemoveArea'</span>, id);
	<span class="comment">//update grand html</span>
	<span class="reserved">if</span> (!mass) {<span class="reserved">this</span>.fireEvent(<span class="literal">'onHtmlChanged'</span>, <span class="reserved">this</span>.getMapHTML());}
};


<span class="comment">/**
 *	Removes all areas.
 *	Will call removeArea on all areas. 
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	2006-06-07 11:55:34
 *	<span class="attrib">@see</span>	#removeArea
 */</span>
imgmap.<span class="reserved">prototype</span>.removeAllAreas = <span class="reserved">function</span>() {
	<span class="reserved">for</span> (var i = 0; i &lt; <span class="reserved">this</span>.areas.length; i++) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i]) {
			<span class="reserved">this</span>.removeArea(i, true);
		}
	}
	<span class="comment">//only call this at the end, use mass param above to avoid calling it in process</span>
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onHtmlChanged'</span>, <span class="reserved">this</span>.getMapHTML());
};


<span class="comment">/**
 *	Put label in the top left corner according to label config.
 *	By default it will contain the number of the area (area.aid) 
 *	<span class="attrib">@param</span>	id	The id of the area to add label to.
 */</span>
imgmap.<span class="reserved">prototype</span>._putlabel = <span class="reserved">function</span>(id) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.areas[id].label) {<span class="reserved">return</span>;}<span class="comment">//not yet inited</span>
	try {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.config.label) {
			<span class="reserved">this</span>.areas[id].label.innerHTML     = <span class="literal">''</span>;
			<span class="reserved">this</span>.areas[id].label.style.display = <span class="literal">'none'</span>;
		}
		<span class="reserved">else</span> {
			<span class="reserved">this</span>.areas[id].label.style.display = <span class="literal">''</span>;
			var label = <span class="reserved">this</span>.config.label;
			label = label.replace(/%n/g, String(id));
			label = label.replace(/%c/g, String(<span class="reserved">this</span>.areas[id].lastInput));
			label = label.replace(/%h/g, String(<span class="reserved">this</span>.areas[id].ahref));
			label = label.replace(/%a/g, String(<span class="reserved">this</span>.areas[id].aalt));
			label = label.replace(/%t/g, String(<span class="reserved">this</span>.areas[id].atitle));
			<span class="reserved">this</span>.areas[id].label.innerHTML = label;
		}
		<span class="comment">//align to the top left corner</span>
		<span class="reserved">this</span>.areas[id].label.style.top  = <span class="reserved">this</span>.areas[id].style.top;
		<span class="reserved">this</span>.areas[id].label.style.left = <span class="reserved">this</span>.areas[id].style.left;
	}
	catch (err) {
		<span class="reserved">this</span>.log(<span class="literal">"Error putting label"</span>, 1);
	}
};


<span class="comment">/**
 *	Set area title and alt (for IE) according to the hint configuration.
 *	This will show up in the usual yellow box when you hover over with the mouse.
 *	<span class="attrib">@param</span>	id	The id of the area to set hint at.
 */</span>
imgmap.<span class="reserved">prototype</span>._puthint = <span class="reserved">function</span>(id) {
	try {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.config.hint) {
			<span class="reserved">this</span>.areas[id].title = <span class="literal">''</span>;
			<span class="reserved">this</span>.areas[id].alt   = <span class="literal">''</span>;
		}
		<span class="reserved">else</span> {
			var hint = <span class="reserved">this</span>.config.hint;
			hint = hint.replace(/%n/g, String(id));
			hint = hint.replace(/%c/g, String(<span class="reserved">this</span>.areas[id].lastInput));
			hint = hint.replace(/%h/g, String(<span class="reserved">this</span>.areas[id].ahref));
			hint = hint.replace(/%a/g, String(<span class="reserved">this</span>.areas[id].aalt));
			hint = hint.replace(/%t/g, String(<span class="reserved">this</span>.areas[id].atitle));
			<span class="reserved">this</span>.areas[id].title = hint;
			<span class="reserved">this</span>.areas[id].alt   = hint;
		}
	}
	catch (err) {
		<span class="reserved">this</span>.log(<span class="literal">"Error putting hint"</span>, 1);
	}
};


<span class="comment">/**
 *	Will call repaint on all areas.
 *	Useful when you change labeling or hint config on the gui.
 *	<span class="attrib">@see</span> #_repaint
 */</span>
imgmap.<span class="reserved">prototype</span>._repaintAll = <span class="reserved">function</span>() {
	<span class="reserved">for</span> (var i=0; i&lt;<span class="reserved">this</span>.areas.length; i++) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i]) {
			<span class="reserved">this</span>._repaint(<span class="reserved">this</span>.areas[i], <span class="reserved">this</span>.config.CL_NORM_SHAPE);
		}
	}
};


<span class="comment">/**
 *	Repaints the actual canvas content.
 *	This is the only canvas drawing magic that is happening.
 *	In fact rectangles will not have any canvas content, just a normal css border.
 *	After repainting the canvas, it will call putlabel and puthint methods.
 *	<span class="attrib">@param</span>	area	The area object.
 *	<span class="attrib">@param</span>	color	Color of the line to draw on the canvas.
 *	<span class="attrib">@param</span>	x	Only used for polygons as the newest control point x.
 *	<span class="attrib">@param</span>	y	Only used for polygons as the newest control point y.
 */</span>  
imgmap.<span class="reserved">prototype</span>._repaint = <span class="reserved">function</span>(area, color, x, y) {
	var ctx;<span class="comment">//canvas context</span>
	var width;<span class="comment">//canvas width</span>
	var height;<span class="comment">//canvas height</span>
	<span class="reserved">if</span> (area.shape == <span class="literal">'circle'</span>) {
		width  = parseInt(area.style.width, 10);
		var radius = Math.floor(width/2) - 1;
		<span class="comment">//get canvas context</span>
		<span class="comment">//alert(area.tagName);</span>
		ctx = area.getContext(<span class="literal">"2d"</span>);
		<span class="comment">//clear canvas</span>
		ctx.clearRect(0, 0, width, width);
		<span class="comment">//draw circle</span>
		ctx.beginPath();
		ctx.strokeStyle = color;
		ctx.arc(radius, radius, radius, 0, Math.PI*2, 0);
		ctx.stroke();
		ctx.closePath();
		<span class="comment">//draw center</span>
		ctx.strokeStyle = <span class="reserved">this</span>.config.CL_KNOB;
		ctx.strokeRect(radius, radius, 1, 1);
		<span class="comment">//put label</span>
		<span class="reserved">this</span>._putlabel(area.aid);
		<span class="reserved">this</span>._puthint(area.aid);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (area.shape == <span class="literal">'rect'</span>) {
		<span class="comment">//put label</span>
		<span class="reserved">this</span>._putlabel(area.aid);
		<span class="reserved">this</span>._puthint(area.aid);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (area.shape == <span class="literal">'poly'</span>) {
		width  =  parseInt(area.style.width, 10);
		height =  parseInt(area.style.height, 10);
		var left   =  parseInt(area.style.left, 10);
		var top    =  parseInt(area.style.top, 10);
		<span class="reserved">if</span> (area.xpoints) {
			<span class="comment">//get canvas context</span>
			ctx = area.getContext(<span class="literal">"2d"</span>);
			<span class="comment">//clear canvas</span>
			ctx.clearRect(0, 0, width, height);
			<span class="comment">//draw polygon</span>
			ctx.beginPath();
			ctx.strokeStyle = color;
			ctx.moveTo(area.xpoints[0] - left, area.ypoints[0] - top);
			<span class="reserved">for</span> (var i=1; i&lt;area.xpoints.length; i++) {
				ctx.lineTo(area.xpoints[i] - left , area.ypoints[i] - top);
			}
			<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_POLYGON_DRAW || <span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_POLYGON_LASTDRAW) {
				<span class="comment">//only draw to current position if not moving</span>
				ctx.lineTo(x - left - 5 , y - top - 5);
			}
			ctx.lineTo(area.xpoints[0] - left , area.ypoints[0] - top);
			ctx.stroke();
			ctx.closePath();
		}
		<span class="comment">//put label</span>
		<span class="reserved">this</span>._putlabel(area.aid);
		<span class="reserved">this</span>._puthint(area.aid);
	}
};


<span class="comment">/**
 *	Updates Area coordinates.
 *	Called when needed, eg. on mousemove, mousedown.
 *	Also updates html container value.
 *	Calls callback onAreaChanged and onHtmlChanged so that gui can follow.
 *	This is an important hook to your gui.  
 *	<span class="attrib">@date</span>	2006.10.24. 22:39:27
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@param</span>	id	The id of the area. 
 */</span>
imgmap.<span class="reserved">prototype</span>._updatecoords = <span class="reserved">function</span>(id) {
	var left   = parseInt(<span class="reserved">this</span>.areas[id].style.left, 10);
	var top    = parseInt(<span class="reserved">this</span>.areas[id].style.top, 10);
	var height = parseInt(<span class="reserved">this</span>.areas[id].style.height, 10);
	var width  = parseInt(<span class="reserved">this</span>.areas[id].style.width, 10);
	
	var value = <span class="literal">''</span> ;
	<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'rect'</span>) {
		value = left + <span class="literal">','</span> + top + <span class="literal">','</span> + (left + width) + <span class="literal">','</span> + (top + height);
		<span class="reserved">this</span>.areas[id].lastInput = value;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'circle'</span>) {
		var radius = Math.floor(width/2) - 1;
		value = (left + radius) + <span class="literal">','</span> +	(top + radius) + <span class="literal">','</span> + radius;
		<span class="reserved">this</span>.areas[id].lastInput = value;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'poly'</span>) {
		value = <span class="literal">''</span>;
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].xpoints) {
			<span class="reserved">for</span> (var i=0; i&lt;<span class="reserved">this</span>.areas[id].xpoints.length; i++) {
				value+= <span class="reserved">this</span>.areas[id].xpoints[i] + <span class="literal">','</span> + <span class="reserved">this</span>.areas[id].ypoints[i] + <span class="literal">','</span>;
			}
			value = value.substring(0, value.length - 1);
		}
		<span class="reserved">this</span>.areas[id].lastInput = value;
	}

	var obj = {}; obj[id] = {}; obj[id].coords = value;
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onAreaChanged'</span>, obj);
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onHtmlChanged'</span>, <span class="reserved">this</span>.getMapHTML());
};


<span class="comment">/**
 *	Updates the visual representation of the area with the given id according
 *	to the new coordinates that typically come from an input on the gui.
 *	<span class="attrib">@date</span>	2006.10.24. 22:46:55
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@param</span>	id	The id of the area.
 *	<span class="attrib">@param</span>	coords	The new coords, they will be normalized.
 */</span>
imgmap.<span class="reserved">prototype</span>._recalculate = <span class="reserved">function</span>(id, coords) {
	try {
		<span class="reserved">if</span> (coords) {
			coords = <span class="reserved">this</span>._normCoords(coords, <span class="reserved">this</span>.areas[id].shape, <span class="literal">'preserve'</span>);
		}
		<span class="reserved">else</span> {
			coords = <span class="reserved">this</span>.areas[id].lastInput || <span class="literal">''</span> ;
		}
	
		var parts   = coords.split(<span class="literal">','</span>);
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'rect'</span>) {
			<span class="reserved">if</span> (parts.length != 4 ||
				parseInt(parts[0], 10) &gt; parseInt(parts[2], 10) ||
				parseInt(parts[1], 10) &gt; parseInt(parts[3], 10)) {throw <span class="literal">"invalid coords"</span>;}
			<span class="reserved">this</span>.areas[id].style.left   = <span class="reserved">this</span>.pic.offsetLeft + parseInt(parts[0], 10) + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.areas[id].style.top    = <span class="reserved">this</span>.pic.offsetTop  + parseInt(parts[1], 10) + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.setAreaSize(id, (parts[2] - parts[0]), (parts[3] - parts[1]));
			<span class="reserved">this</span>._repaint(<span class="reserved">this</span>.areas[id], <span class="reserved">this</span>.config.CL_NORM_SHAPE);
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'circle'</span>) {
			<span class="reserved">if</span> (parts.length != 3 ||
				parseInt(parts[2], 10) &lt; 0) {throw <span class="literal">"invalid coords"</span>;}
			var width = 2 * (1 * parts[2] + 1);
			<span class="comment">//alert(parts[2]);</span>
			<span class="comment">//alert(width);</span>
			<span class="reserved">this</span>.setAreaSize(id, width, width);
			<span class="reserved">this</span>.areas[id].style.left   = <span class="reserved">this</span>.pic.offsetLeft + parseInt(parts[0], 10) - width/2 + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.areas[id].style.top    = <span class="reserved">this</span>.pic.offsetTop  + parseInt(parts[1], 10) - width/2 + <span class="literal">'px'</span>;
			<span class="reserved">this</span>._repaint(<span class="reserved">this</span>.areas[id], <span class="reserved">this</span>.config.CL_NORM_SHAPE);
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'poly'</span>) {
			<span class="reserved">if</span> (parts.length &lt; 2) {throw <span class="literal">"invalid coords"</span>;}
			<span class="reserved">this</span>.areas[id].xpoints = [];
			<span class="reserved">this</span>.areas[id].ypoints = [];
			<span class="reserved">for</span> (var i=0; i&lt;parts.length; i+=2) {
				<span class="reserved">this</span>.areas[id].xpoints[<span class="reserved">this</span>.areas[id].xpoints.length]  = <span class="reserved">this</span>.pic.offsetLeft + parseInt(parts[i], 10);
				<span class="reserved">this</span>.areas[id].ypoints[<span class="reserved">this</span>.areas[id].ypoints.length]  = <span class="reserved">this</span>.pic.offsetTop  + parseInt(parts[i+1], 10); 
				<span class="reserved">this</span>._polygongrow(<span class="reserved">this</span>.areas[id], parts[i], parts[i+1]);
			}
			<span class="reserved">this</span>._polygonshrink(<span class="reserved">this</span>.areas[id]);<span class="comment">//includes repaint</span>
		}
	}
	catch (err) {
		var msg = (err.message) ? err.message : <span class="literal">'error calculating coordinates'</span>;
		<span class="reserved">this</span>.log(msg, 1);
		<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.ERR_INVALID_COORDS);
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].lastInput &amp;&amp; input) {input.value = <span class="reserved">this</span>.areas[id].lastInput;}
		<span class="reserved">this</span>._repaint(<span class="reserved">this</span>.areas[id], <span class="reserved">this</span>.config.CL_NORM_SHAPE);
		<span class="reserved">return</span>;
	}
	<span class="comment">//on success update lastInput</span>
	<span class="reserved">this</span>.areas[id].lastInput = coords;
};


<span class="comment">/**
 *	Grow polygon area to be able to contain the given new coordinates.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	area	The area to grow.
 *	<span class="attrib">@param</span>	newx	The new coordinate x.  
 *	<span class="attrib">@param</span>	newy	The new coordinate y.	 
 *	<span class="attrib">@see</span>	#_polygonshrink 
 */</span>
imgmap.<span class="reserved">prototype</span>._polygongrow = <span class="reserved">function</span>(area, newx, newy) {
	<span class="comment">//this.log('pgrow');</span>
	var xdiff = newx - parseInt(area.style.left, 10);
	var ydiff = newy - parseInt(area.style.top , 10);
	var pad   = 0;<span class="comment">//padding on the edges</span>
	var pad2  = 0;<span class="comment">//twice the padding</span>
	
	<span class="reserved">if</span> (newx &lt; parseInt(area.style.left, 10)) {
		area.style.left   = (newx - pad) + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.setAreaSize(area.aid, parseInt(area.style.width, 10) + Math.abs(xdiff) + pad2, null);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (newx &gt; parseInt(area.style.left, 10) + parseInt(area.style.width, 10)) {
		<span class="reserved">this</span>.setAreaSize(area.aid, newx - parseInt(area.style.left, 10) + pad2, null);
	}
	<span class="reserved">if</span> (newy &lt; parseInt(area.style.top, 10)) {
		area.style.top    = (newy - pad) + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.setAreaSize(area.aid, null, parseInt(area.style.height, 10) + Math.abs(ydiff) + pad2);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (newy &gt; parseInt(area.style.top, 10) + parseInt(area.style.height, 10)) {
		<span class="reserved">this</span>.setAreaSize(area.aid, null, newy - parseInt(area.style.top, 10) + pad2);
	}
};


<span class="comment">/**
 *	Shrink the polygon bounding area to the necessary size, by first reducing it
 *	to the minimum, and then gradually growing it.
 *	We need this because while we were drawing the polygon, it might have expanded
 *	the canvas more than needed.
 *	Will repaint the area. 
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	area	The area to shrink.
 *	<span class="attrib">@see</span>	#_polygongrow 
 */</span>
imgmap.<span class="reserved">prototype</span>._polygonshrink = <span class="reserved">function</span>(area) {
	<span class="comment">//this.log('pshrink');</span>
	area.style.left = (area.xpoints[0]) + <span class="literal">'px'</span>;
	area.style.top  = (area.ypoints[0]) + <span class="literal">'px'</span>;
	<span class="reserved">this</span>.setAreaSize(area.aid, 0, 0);
	<span class="reserved">for</span> (var i=0; i&lt;area.xpoints.length; i++) {
		<span class="reserved">this</span>._polygongrow(area, area.xpoints[i], area.ypoints[i]);
	}
	<span class="reserved">this</span>._repaint(area, <span class="reserved">this</span>.config.CL_NORM_SHAPE);
};


<span class="comment">/**
 *	EVENT HANDLER: Handles mousemove on the image.
 *	This is the main drawing routine.
 *	Depending on the current shape, will draw the rect/circle/poly to the new position. 
 *	<span class="attrib">@param</span>	e	The event object.
 */</span>
imgmap.<span class="reserved">prototype</span>.img_mousemove = <span class="reserved">function</span>(e) {
	<span class="comment">//function level var declarations</span>
	var x;
	var y;
	var xdiff;
	var ydiff;
	var diff;

	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="comment">//event.x is relative to parent element, but page.x is NOT</span>
	<span class="comment">//pos coordinates are the same absolute coords, offset coords are relative to parent</span>
	var pos = <span class="reserved">this</span>._getPos(<span class="reserved">this</span>.pic);
	x = (<span class="reserved">this</span>.isMSIE) ? (window.event.x - <span class="reserved">this</span>.pic.offsetLeft) : (e.pageX - pos.x);
	y = (<span class="reserved">this</span>.isMSIE) ? (window.event.y - <span class="reserved">this</span>.pic.offsetTop)  : (e.pageY - pos.y);
	x = x + <span class="reserved">this</span>.pic_container.scrollLeft;
	y = y + <span class="reserved">this</span>.pic_container.scrollTop;
	
	
	<span class="comment">//this.log(x + ' - ' + y + ': ' + this.memory[this.currentid].downx + ' - ' +this.memory[this.currentid].downy);</span>
	
	<span class="comment">//exit if outside image</span>
	<span class="reserved">if</span> (x&lt;0 || y&lt;0 || x&gt;<span class="reserved">this</span>.pic.width || y&gt;<span class="reserved">this</span>.pic.height) {<span class="reserved">return</span>;}
	
	<span class="comment">//old dimensions that need to be updated in this function</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid]) {
		var top    = <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].top;
		var left   = <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].left;
		var height = <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].height;
		var width  = <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].width;
	}
	
	<span class="comment">// Handle shift state for Safari</span>
	<span class="comment">// Safari doesn't generate keyboard events for modifiers: http://bugs.webkit.org/show_bug.cgi?id=11696</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.isSafari) {
		<span class="reserved">if</span> (e.shiftKey) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_RECTANGLE_DRAW) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_DRAW;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.SQUARE2_DRAW);
			}
		}
		<span class="reserved">else</span> {
			<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_SQUARE_DRAW &amp;&amp; <span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'rect'</span>) {
				<span class="comment">//not for circle!</span>
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_DRAW;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.RECTANGLE_DRAW);
			}
		}
	}

	
	<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_RECTANGLE_DRAW) {
		<span class="comment">//rectangle mode</span>
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onDrawArea'</span>, <span class="reserved">this</span>.currentid);
		xdiff = x - <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downx;
		ydiff = y - <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downy;
		<span class="comment">//alert(xdiff);</span>
		<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, Math.abs(xdiff), Math.abs(ydiff));
		<span class="reserved">if</span> (xdiff &lt; 0) {
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left = (x + 1) + <span class="literal">'px'</span>;
		}
		<span class="reserved">if</span> (ydiff &lt; 0) {
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top  = (y + 1) + <span class="literal">'px'</span>;
		}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_SQUARE_DRAW) {
		<span class="comment">//square mode - align to shorter side</span>
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onDrawArea'</span>, <span class="reserved">this</span>.currentid);
		xdiff = x - <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downx;
		ydiff = y - <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downy;
		<span class="reserved">if</span> (Math.abs(xdiff) &lt; Math.abs(ydiff)) {
			diff = Math.abs(parseInt(xdiff, 10));
		}
		<span class="reserved">else</span> {
			diff = Math.abs(parseInt(ydiff, 10));
		}
		<span class="comment">//alert(xdiff);</span>
		<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, diff, diff);
		<span class="reserved">if</span> (xdiff &lt; 0) {
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left = (<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downx + diff*-1) + <span class="literal">'px'</span>;
		}
		<span class="reserved">if</span> (ydiff &lt; 0) {
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top = (<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downy + diff*-1 + 1) + <span class="literal">'px'</span>;
		}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_POLYGON_DRAW) {
		<span class="comment">//polygon mode</span>
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onDrawArea'</span>, <span class="reserved">this</span>.currentid);
		<span class="reserved">this</span>._polygongrow(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid], x, y);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_RECTANGLE_MOVE || <span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_SQUARE_MOVE) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onMoveArea'</span>, <span class="reserved">this</span>.currentid);
		x = x - <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdownx;
		y = y - <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdowny;
		<span class="reserved">if</span> (x + width &gt; <span class="reserved">this</span>.pic.width || y + height &gt; <span class="reserved">this</span>.pic.height) {<span class="reserved">return</span>;}
		<span class="reserved">if</span> (x &lt; 0 || y &lt; 0) {<span class="reserved">return</span>;}
		<span class="comment">//this.log(x + ' - '+width+ '+'+this.memory[this.currentid].rdownx +'='+xdiff );</span>
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left = x + 1 + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top  = y + 1 + <span class="literal">'px'</span>;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_POLYGON_MOVE) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onMoveArea'</span>, <span class="reserved">this</span>.currentid);
		x = x - <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdownx;
		y = y - <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdowny;
		<span class="reserved">if</span> (x + width &gt; <span class="reserved">this</span>.pic.width || y + height &gt; <span class="reserved">this</span>.pic.height) {<span class="reserved">return</span>;}
		<span class="reserved">if</span> (x &lt; 0 || y &lt; 0) {<span class="reserved">return</span>;}
		xdiff = x - left;
		ydiff = y - top;
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints) {
			<span class="reserved">for</span> (var i=0; i&lt;<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints.length; i++) {
				<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints[i] = <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].xpoints[i] + xdiff;
				<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].ypoints[i] = <span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].ypoints[i] + ydiff;
			}
		}
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left = x + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top  = y + <span class="literal">'px'</span>;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_SQUARE_RESIZE_LEFT) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onResizeArea'</span>, <span class="reserved">this</span>.currentid);
		diff = x - left;
		<span class="comment">//alert(diff);</span>
		<span class="reserved">if</span> ((width  + (-1 * diff)) &gt; 0) {
			<span class="comment">//real resize left</span>
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left   = x + 1 + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top    = (top    + (diff/2)) + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, parseInt(width  + (-1 * diff), 10), parseInt(height + (-1 * diff), 10));
		}
		<span class="reserved">else</span> {
			<span class="comment">//jump to another state</span>
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].width  = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].height = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].left   = x;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].top    = y;
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_RESIZE_RIGHT;
		}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_SQUARE_RESIZE_RIGHT) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onResizeArea'</span>, <span class="reserved">this</span>.currentid);
		diff = x - left - width;
		<span class="reserved">if</span> ((width  + (diff)) - 1 &gt; 0) {
			<span class="comment">//real resize right</span>
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top    = (top    + (-1* diff/2)) + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, (width  + (diff)) - 1, (height + (diff)));
		}
		<span class="reserved">else</span> {
			<span class="comment">//jump to another state</span>
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].width  = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].height = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].left   = x;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].top    = y;
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_RESIZE_LEFT;
		}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_SQUARE_RESIZE_TOP) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onResizeArea'</span>, <span class="reserved">this</span>.currentid);
		diff = y - top;
		<span class="reserved">if</span> ((width  + (-1 * diff)) &gt; 0) {
			<span class="comment">//real resize top</span>
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top    = y + 1 + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left   = (left   + (diff/2)) + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, (width  + (-1 * diff)), (height + (-1 * diff)));
		}
		<span class="reserved">else</span> {
			<span class="comment">//jump to another state</span>
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].width  = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].height = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].left   = x;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].top    = y;
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_RESIZE_BOTTOM;
		}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_SQUARE_RESIZE_BOTTOM) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onResizeArea'</span>, <span class="reserved">this</span>.currentid);
		diff = y - top - height;
		<span class="reserved">if</span> ((width  + (diff)) - 1 &gt; 0) {
			<span class="comment">//real resize bottom</span>
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left   = (left   + (-1* diff/2)) + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, (width  + (diff)) - 1 , (height + (diff)) - 1);
		}
		<span class="reserved">else</span> {
			<span class="comment">//jump to another state</span>
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].width  = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].height = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].left   = x;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].top    = y;
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_RESIZE_TOP;
		}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_LEFT) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onResizeArea'</span>, <span class="reserved">this</span>.currentid);
		xdiff = x - left;
		<span class="reserved">if</span> (width + (-1 * xdiff) &gt; 0) {
			<span class="comment">//real resize left</span>
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left = x + 1 + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, width + (-1 * xdiff), null);
		}
		<span class="reserved">else</span> {
			<span class="comment">//jump to another state</span>
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].width = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].left  = x;
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_RIGHT;
		}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_RIGHT) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onResizeArea'</span>, <span class="reserved">this</span>.currentid);
		xdiff = x - left - width;
		<span class="reserved">if</span> ((width  + (xdiff)) - 1 &gt; 0) {
			<span class="comment">//real resize right</span>
			<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, (width  + (xdiff)) - 1, null);
		}
		<span class="reserved">else</span> {
			<span class="comment">//jump to another state</span>
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].width = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].left  = x;
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_LEFT;
		}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_TOP) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onResizeArea'</span>, <span class="reserved">this</span>.currentid);
		ydiff = y - top;
		<span class="reserved">if</span> ((height + (-1 * ydiff)) &gt; 0) {
			<span class="comment">//real resize top</span>
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top   = y + 1 + <span class="literal">'px'</span>;
			<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, null, (height + (-1 * ydiff)));
		}
		<span class="reserved">else</span> {
			<span class="comment">//jump to another state</span>
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].height = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].top    = y;
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_BOTTOM;
		}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_BOTTOM) {
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onResizeArea'</span>, <span class="reserved">this</span>.currentid);
		ydiff = y - top - height;
		<span class="reserved">if</span> ((height + (ydiff)) - 1 &gt; 0) {
			<span class="comment">//real resize bottom</span>
			<span class="reserved">this</span>.setAreaSize(<span class="reserved">this</span>.currentid, null, (height + (ydiff)) - 1);
		}
		<span class="reserved">else</span> {
			<span class="comment">//jump to another state</span>
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].height = 0;
			<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].top    = y;
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_TOP;
		}
	}
	
	<span class="comment">//repaint canvas elements</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing) {
		<span class="reserved">this</span>._repaint(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid], <span class="reserved">this</span>.config.CL_DRAW_SHAPE, x, y);
		<span class="reserved">this</span>._updatecoords(<span class="reserved">this</span>.currentid);
	}

};


<span class="comment">/**
 *	EVENT HANDLER: Handles mouseup on the image.
 *	Handles dragging and resizing.
 *	<span class="attrib">@param</span>	e	The event object.
 */</span>
imgmap.<span class="reserved">prototype</span>.img_mouseup = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="comment">//console.log('img_mouseup');</span>
	<span class="comment">//if (!this.props[this.currentid]) return;</span>
	var pos = <span class="reserved">this</span>._getPos(<span class="reserved">this</span>.pic);
	var x = (<span class="reserved">this</span>.isMSIE) ? (window.event.x - <span class="reserved">this</span>.pic.offsetLeft) : (e.pageX - pos.x);
	var y = (<span class="reserved">this</span>.isMSIE) ? (window.event.y - <span class="reserved">this</span>.pic.offsetTop)  : (e.pageY - pos.y);
	x = x + <span class="reserved">this</span>.pic_container.scrollLeft;
	y = y + <span class="reserved">this</span>.pic_container.scrollTop;
	<span class="comment">//for everything that is move or resize</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing != <span class="reserved">this</span>.DM_RECTANGLE_DRAW &amp;&amp;
		<span class="reserved">this</span>.is_drawing != <span class="reserved">this</span>.DM_SQUARE_DRAW &amp;&amp;
		<span class="reserved">this</span>.is_drawing != <span class="reserved">this</span>.DM_POLYGON_DRAW &amp;&amp;
		<span class="reserved">this</span>.is_drawing != <span class="reserved">this</span>.DM_POLYGON_LASTDRAW) {
		<span class="comment">//end dragging</span>
		<span class="reserved">this</span>.draggedId = null;
		<span class="comment">//finish state</span>
		<span class="reserved">this</span>.is_drawing = 0;
		<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.READY);
		<span class="reserved">this</span>.relaxArea(<span class="reserved">this</span>.currentid);
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid] == <span class="reserved">this</span>._getLastArea()) {
			<span class="comment">//if (this.config.mode != "editor2") this.addNewArea();</span>
			<span class="reserved">return</span>;
		}
		<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downx  = x;
		<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downy  = y;
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handles mousedown on the image.
 *	Handles beggining or end of draw, or polygon point set.
 *	<span class="attrib">@param</span>	e	The event object.
 */</span>
imgmap.<span class="reserved">prototype</span>.img_mousedown = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid] &amp;&amp; <span class="reserved">this</span>.config.mode != <span class="literal">"editor2"</span>) {<span class="reserved">return</span>;}
	<span class="comment">//console.log('img_mousedown');</span>
	var pos = <span class="reserved">this</span>._getPos(<span class="reserved">this</span>.pic);

	var x = (<span class="reserved">this</span>.isMSIE) ? (window.event.x - <span class="reserved">this</span>.pic.offsetLeft) : (e.pageX - pos.x);
	var y = (<span class="reserved">this</span>.isMSIE) ? (window.event.y - <span class="reserved">this</span>.pic.offsetTop)  : (e.pageY - pos.y);
	x = x + <span class="reserved">this</span>.pic_container.scrollLeft;
	y = y + <span class="reserved">this</span>.pic_container.scrollTop;
	
	<span class="comment">// Handle the Shift state</span>
	<span class="reserved">if</span> (!e) {
		e = window.event;
	}

	<span class="reserved">if</span> (e.shiftKey)	{
		<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_POLYGON_DRAW) {
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_POLYGON_LASTDRAW;
		}
	}
	<span class="comment">//console.log(this.is_drawing);</span>
	<span class="comment">//this.statusMessage(x + ' - ' + y + ': ' + this.props[this.currentid].getElementsByTagName('select')[0].value);</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_POLYGON_DRAW) {
		<span class="comment">//its not finish state yet</span>
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints[<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints.length] = x - 5;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].ypoints[<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].ypoints.length] = y - 5;
		<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downx  = x;
		<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downy  = y;
		<span class="reserved">return</span>;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing &amp;&amp; <span class="reserved">this</span>.is_drawing != <span class="reserved">this</span>.DM_POLYGON_DRAW) {
		<span class="comment">//finish any other state</span>
		<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_POLYGON_LASTDRAW) {
			<span class="comment">//add last controlpoint and update coords</span>
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints[<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints.length] = x - 5;
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].ypoints[<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].ypoints.length] = y - 5;
			<span class="reserved">this</span>._updatecoords(<span class="reserved">this</span>.currentid);
			<span class="reserved">this</span>.is_drawing = 0;
			<span class="reserved">this</span>._polygonshrink(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid]);
		}
		<span class="reserved">this</span>.is_drawing = 0;
		<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.READY);
		<span class="reserved">this</span>.relaxArea(<span class="reserved">this</span>.currentid);
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid] == <span class="reserved">this</span>._getLastArea()) {
			<span class="comment">//editor mode adds next area automatically</span>
			<span class="reserved">if</span> (<span class="reserved">this</span>.config.mode != <span class="literal">"editor2"</span>) {<span class="reserved">this</span>.addNewArea();}
			<span class="reserved">return</span>;
		}
		<span class="reserved">return</span>;
	}
	
	<span class="reserved">if</span> (<span class="reserved">this</span>.config.mode == <span class="literal">"editor2"</span>) {
		<span class="reserved">if</span> (!<span class="reserved">this</span>.nextShape) {<span class="reserved">return</span>;}
		<span class="reserved">this</span>.addNewArea();
		<span class="comment">//console.log("init: " + this.nextShape);</span>
		<span class="reserved">this</span>.initArea(<span class="reserved">this</span>.currentid, <span class="reserved">this</span>.nextShape);
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'undefined'</span> || <span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'poly'</span>) {
		<span class="comment">//var shape = (this.props[this.currentid]) ? this.props[this.currentid].getElementsByTagName('select')[0].value : this.nextShape;</span>
		var shape = <span class="reserved">this</span>.nextShape;
		<span class="reserved">if</span> (!shape) {shape = <span class="literal">'rect'</span>;}
		<span class="comment">//console.log("init: " + shape);</span>
		<span class="reserved">this</span>.initArea(<span class="reserved">this</span>.currentid, shape);
	}
	<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'poly'</span>) {
		<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_POLYGON_DRAW;
		<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.POLYGON_DRAW);
		
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left = x + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top  = y + <span class="literal">'px'</span>;
		<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderWidth = <span class="literal">'1px'</span>;
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderStyle = <span class="literal">'dotted'</span>;
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_BOX;
		}
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.width  = 0;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.height = 0;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints = [];
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].ypoints = [];
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints[0] = x;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].ypoints[0] = y;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'rect'</span>) {
		<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_DRAW;
		<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.RECTANGLE_DRAW);
		
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left = x + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top  = y + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderWidth = <span class="literal">'1px'</span>;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderStyle = <span class="literal">'dotted'</span>;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_SHAPE;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.width  = 0;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.height = 0;
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'circle'</span>) {
		<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_DRAW;
		<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.SQUARE_DRAW);
				
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left = x + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top  = y + <span class="literal">'px'</span>;
		<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderWidth = <span class="literal">'1px'</span>;
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderStyle = <span class="literal">'dotted'</span>;
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_BOX;
		}
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.width  = 0;
		<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.height = 0;
	}

	<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downx  = x;
	<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].downy  = y;
};


<span class="comment">/**
 *	Highlights a given area.
 *	Sets opacity and repaints. 
 *	<span class="attrib">@date</span>	2007.12.28. 18:23:00
 *	<span class="attrib">@param</span>	id	The id of the area to blur.
 *	<span class="attrib">@param</span>	flag	Modifier, possible values: grad - for gradual fade in
 */</span>
imgmap.<span class="reserved">prototype</span>.highlightArea = <span class="reserved">function</span>(id, flag) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing) {<span class="reserved">return</span>;}<span class="comment">//exit if in drawing state</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id] &amp;&amp; <span class="reserved">this</span>.areas[id].shape != <span class="literal">'undefined'</span>) {
		<span class="comment">//area exists - highlight it</span>
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onFocusArea'</span>, <span class="reserved">this</span>.areas[id]);
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'rect'</span>) {
			<span class="reserved">this</span>.areas[id].style.borderWidth = <span class="literal">'1px'</span>;
			<span class="reserved">this</span>.areas[id].style.borderStyle = <span class="literal">'solid'</span>;
			<span class="reserved">this</span>.areas[id].style.borderColor = <span class="reserved">this</span>.config.CL_HIGHLIGHT_SHAPE;
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'circle'</span> || <span class="reserved">this</span>.areas[id].shape == <span class="literal">'poly'</span>) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
				<span class="reserved">this</span>.areas[id].style.borderWidth = <span class="literal">'1px'</span>;
				<span class="reserved">this</span>.areas[id].style.borderStyle = <span class="literal">'solid'</span>;
				<span class="reserved">this</span>.areas[id].style.borderColor = <span class="reserved">this</span>.config.CL_HIGHLIGHT_BOX;
			}
		}
		var opacity = <span class="reserved">this</span>.config.highlight_opacity;
		<span class="reserved">if</span> (flag == <span class="literal">'grad'</span>) {
			<span class="comment">//apply gradient opacity</span>
			opacity = <span class="literal">'-'</span> + opacity;
		}
		<span class="reserved">this</span>._setopacity(<span class="reserved">this</span>.areas[id], <span class="reserved">this</span>.config.CL_HIGHLIGHT_BG, opacity);
		<span class="reserved">this</span>._repaint(<span class="reserved">this</span>.areas[id], <span class="reserved">this</span>.config.CL_HIGHLIGHT_SHAPE);
	}
};


<span class="comment">/**
 *	Blurs a given area.
 *	Sets opacity and repaints. 
 *	<span class="attrib">@date</span>	2007.12.28. 18:23:26
 *	<span class="attrib">@param</span>	id	The id of the area to blur.
 *	<span class="attrib">@param</span>	flag	Modifier, possible values: grad - for gradual fade out
 */</span>
imgmap.<span class="reserved">prototype</span>.blurArea = <span class="reserved">function</span>(id, flag) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing) {<span class="reserved">return</span>;}<span class="comment">//exit if in drawing state</span>
	<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id] &amp;&amp; <span class="reserved">this</span>.areas[id].shape != <span class="literal">'undefined'</span>) {
		<span class="comment">//area exists - fade it back</span>
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onBlurArea'</span>, <span class="reserved">this</span>.areas[id]);
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'rect'</span>) {
			<span class="reserved">this</span>.areas[id].style.borderWidth = <span class="literal">'1px'</span>;
			<span class="reserved">this</span>.areas[id].style.borderStyle = <span class="literal">'solid'</span>;
			<span class="reserved">this</span>.areas[id].style.borderColor = <span class="reserved">this</span>.config.CL_NORM_SHAPE;
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[id].shape == <span class="literal">'circle'</span> || <span class="reserved">this</span>.areas[id].shape == <span class="literal">'poly'</span>) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
				<span class="reserved">this</span>.areas[id].style.borderWidth = <span class="literal">'1px'</span>;
				<span class="reserved">this</span>.areas[id].style.borderStyle = <span class="literal">'solid'</span>;
				<span class="reserved">this</span>.areas[id].style.borderColor = <span class="reserved">this</span>.config.CL_NORM_BOX;
			}
		}
		var opacity = <span class="reserved">this</span>.config.norm_opacity;
		<span class="reserved">if</span> (flag == <span class="literal">'grad'</span>) {
			<span class="comment">//apply gradient opacity</span>
			opacity = <span class="literal">'-'</span> + opacity;
		}
		<span class="reserved">this</span>._setopacity(<span class="reserved">this</span>.areas[id], <span class="reserved">this</span>.config.CL_NORM_BG, opacity);
		<span class="reserved">this</span>._repaint(<span class="reserved">this</span>.areas[id], <span class="reserved">this</span>.config.CL_NORM_SHAPE);
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handles event of mousemove on imgmap areas.
 *	- changes cursor depending where we are inside the area (buggy in opera)
 *	- handles area resize
 *	- handles area move   
 *	<span class="attrib">@url</span>	http://evolt.org/article/Mission_Impossible_mouse_position/17/23335/index.html
 *	<span class="attrib">@url</span>	http://my.opera.com/community/forums/topic.dml?id=239498&amp;t=1217158015&amp;page=1 
 *	<span class="attrib">@author</span>	adam 
 */</span>
imgmap.<span class="reserved">prototype</span>.area_mousemove = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.is_drawing) {
		var obj = (<span class="reserved">this</span>.isMSIE) ? window.event.srcElement : e.currentTarget;
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'DIV'</span>) {
			<span class="comment">//do this because of label</span>
			obj = obj.parentNode;
		}
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'image'</span> || obj.tagName == <span class="literal">'group'</span> ||
			obj.tagName == <span class="literal">'shape'</span> || obj.tagName == <span class="literal">'stroke'</span>) {
			<span class="comment">//do this because of excanvas</span>
			obj = obj.parentNode.parentNode;
		}
		<span class="comment">//opera fix - adam - 04-12-2007 23:14:05</span>
		<span class="reserved">if</span> (<span class="reserved">this</span>.isOpera) {
			e.layerX = e.offsetX;
			e.layerY = e.offsetY;
		}
		var xdiff = (<span class="reserved">this</span>.isMSIE) ? (window.event.offsetX) : (e.layerX);
		var ydiff = (<span class="reserved">this</span>.isMSIE) ? (window.event.offsetY) : (e.layerY);
		<span class="comment">//this.log(obj.aid + ' : ' + xdiff + ',' + ydiff);</span>
		<span class="reserved">if</span> (xdiff &lt; 6 &amp;&amp; ydiff &gt; 6) {
			<span class="comment">//move left</span>
			<span class="reserved">if</span> (obj.shape != <span class="literal">'poly'</span>) {
				obj.style.cursor = <span class="literal">'w-resize'</span>;
			}
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (xdiff &gt; parseInt(obj.style.width, 10) - 6  &amp;&amp; ydiff &gt; 6) {
			<span class="comment">//move right</span>
			<span class="reserved">if</span> (obj.shape != <span class="literal">'poly'</span>) {
				obj.style.cursor = <span class="literal">'e-resize'</span>;
			}
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (xdiff &gt; 6 &amp;&amp; ydiff &lt; 6) {
			<span class="comment">//move top</span>
			<span class="reserved">if</span> (obj.shape != <span class="literal">'poly'</span>) {
				obj.style.cursor = <span class="literal">'n-resize'</span>;
			}
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (ydiff &gt; parseInt(obj.style.height, 10) - 6  &amp;&amp; xdiff &gt; 6) {
			<span class="comment">//move bottom</span>
			<span class="reserved">if</span> (obj.shape != <span class="literal">'poly'</span>) {
				obj.style.cursor = <span class="literal">'s-resize'</span>;
			}
		}
		<span class="reserved">else</span> {
			<span class="comment">//move all</span>
			obj.style.cursor = <span class="literal">'move'</span>;
		}
		<span class="reserved">if</span> (obj.aid != <span class="reserved">this</span>.draggedId) {
			<span class="comment">//not dragged or different</span>
			<span class="reserved">if</span> (obj.style.cursor == <span class="literal">'move'</span>) {obj.style.cursor = <span class="literal">'default'</span>;}
			<span class="reserved">return</span>;
		}
		<span class="comment">//moved here from mousedown</span>
		<span class="reserved">if</span> (xdiff &lt; 6 &amp;&amp; ydiff &gt; 6) {
			<span class="comment">//move left</span>
			<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'circle'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_RESIZE_LEFT;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.SQUARE_RESIZE_LEFT);
				<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
					<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_BOX;
				}
			}
			<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'rect'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_LEFT;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.RECTANGLE_RESIZE_LEFT);
				<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_SHAPE;
			}
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (xdiff &gt; parseInt(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.width, 10) - 6  &amp;&amp; ydiff &gt; 6) {
			<span class="comment">//move right</span>
			<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'circle'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_RESIZE_RIGHT;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.SQUARE_RESIZE_RIGHT);
				<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
					<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_BOX;
				}
			}
			<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'rect'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_RIGHT;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.RECTANGLE_RESIZE_RIGHT);
				<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_SHAPE;
			}
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (xdiff &gt; 6 &amp;&amp; ydiff &lt; 6) {
			<span class="comment">//move top</span>
			<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'circle'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_RESIZE_TOP;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.SQUARE_RESIZE_TOP);
				<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
					<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_BOX;
				}
			}
			<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'rect'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_TOP;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.RECTANGLE_RESIZE_TOP);
				<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_SHAPE;
			}
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (ydiff &gt; parseInt(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.height, 10) - 6  &amp;&amp; xdiff &gt; 6) {
			<span class="comment">//move bottom</span>
			<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'circle'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_RESIZE_BOTTOM;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.SQUARE_RESIZE_BOTTOM);
				<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
					<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_BOX;
				}
			}
			<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'rect'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_RESIZE_BOTTOM;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.RECTANGLE_RESIZE_BOTTOM);
				<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_SHAPE;
			}
		}
		<span class="reserved">else</span><span class="comment">/*if (xdiff &lt; 10 &amp;&amp; ydiff &lt; 10 ) */</span>{
			<span class="comment">//move all</span>
			<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'circle'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_MOVE;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.SQUARE_MOVE);
				<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
					<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_BOX;
				}
				<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdownx = xdiff;
				<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdowny = ydiff;
			}
			<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'rect'</span>) {
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_MOVE;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.RECTANGLE_MOVE);
				<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_SHAPE;
				<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdownx = xdiff;
				<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdowny = ydiff;
			}
			<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'poly'</span>) {
				<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints) {
					<span class="reserved">for</span> (var i=0; i&lt;<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints.length; i++) {
						<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].xpoints[i] = <span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].xpoints[i];
						<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].ypoints[i] = <span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].ypoints[i];
					}
				}
				<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_POLYGON_MOVE;
				<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.POLYGON_MOVE);
				<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
					<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderColor = <span class="reserved">this</span>.config.CL_DRAW_BOX;
				}
				<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdownx = xdiff;
				<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].rdowny = ydiff;
			}
		}
		
		<span class="comment">//common memory settings (preparing to move or resize)</span>
		<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].width  = parseInt(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.width, 10);
		<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].height = parseInt(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.height, 10);
		<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].top    = parseInt(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.top, 10);
		<span class="reserved">this</span>.memory[<span class="reserved">this</span>.currentid].left   = parseInt(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.left, 10);
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'rect'</span>) {
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderWidth = <span class="literal">'1px'</span>;
			<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderStyle = <span class="literal">'dotted'</span>;
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'circle'</span> || <span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'poly'</span>) {
			<span class="reserved">if</span> (<span class="reserved">this</span>.config.bounding_box) {
				<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderWidth = <span class="literal">'1px'</span>;
				<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].style.borderStyle = <span class="literal">'dotted'</span>;
			}
		}
		<span class="reserved">this</span>._setopacity(<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid], <span class="reserved">this</span>.config.CL_DRAW_BG, <span class="reserved">this</span>.config.draw_opacity);
	}
	<span class="reserved">else</span> {
		<span class="comment">//if drawing and not ie, have to propagate to image event</span>
		<span class="reserved">this</span>.img_mousemove(e);
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handles event of mouseup on imgmap areas.
 *	Basically clears draggedId.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	e	The event object
 */</span>
imgmap.<span class="reserved">prototype</span>.area_mouseup = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="comment">//console.log('area_mouseup');</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.is_drawing) {
		var obj = (<span class="reserved">this</span>.isMSIE) ? window.event.srcElement : e.currentTarget;
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'DIV'</span>) {
			<span class="comment">//do this because of label</span>
			obj = obj.parentNode;
		}
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'image'</span> || obj.tagName == <span class="literal">'group'</span> ||
			obj.tagName == <span class="literal">'shape'</span> || obj.tagName == <span class="literal">'stroke'</span>) {
			<span class="comment">//do this because of excanvas</span>
			obj = obj.parentNode.parentNode;
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid] != obj) {
			<span class="comment">//trying to draw on a different canvas,switch to this one</span>
			<span class="reserved">if</span> (typeof obj.aid == <span class="literal">'undefined'</span>) {
				<span class="reserved">this</span>.log(<span class="literal">'Cannot identify target area'</span>, 1);
				<span class="reserved">return</span>;
			}
			<span class="comment">//this.form_selectRow(obj.aid, true);</span>
			<span class="comment">//this.currentid = obj.aid;</span>
		}
		<span class="reserved">this</span>.draggedId = null;
	}
	<span class="reserved">else</span> {
		<span class="comment">//if drawing and not ie, have to propagate to image event</span>
		<span class="comment">//console.log('propup');</span>
		<span class="reserved">this</span>.img_mouseup(e);
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handles event of mouseover on imgmap areas.
 *	Calls gradual highlight on the given area.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	e	The event object
 */</span>
imgmap.<span class="reserved">prototype</span>.area_mouseover = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1 &amp;&amp; <span class="reserved">this</span>.config.mode !== <span class="literal">''</span>) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.is_drawing) {
		<span class="comment">//this.log('area_mouseover');</span>
		<span class="comment">//identify source object</span>
		var obj = (<span class="reserved">this</span>.isMSIE) ? window.event.srcElement : e.currentTarget;
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'DIV'</span>) {
			<span class="comment">//do this because of label</span>
			obj = obj.parentNode;
		}
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'image'</span> || obj.tagName == <span class="literal">'group'</span> ||
			obj.tagName == <span class="literal">'shape'</span> || obj.tagName == <span class="literal">'stroke'</span>) {
			<span class="comment">//do this because of excanvas</span>
			obj = obj.parentNode.parentNode;
		}
		<span class="comment">/*
		//switch to hovered area
		if (this.areas[this.currentid] != obj) {
			//trying to draw on a different canvas, switch to this one
			if (typeof obj.aid == 'undefined') {
				this.log('Cannot identify target area', 1);
				return;
			}
			this.form_selectRow(obj.aid, true);
			this.currentid = obj.aid;
		}
		*/</span>
		<span class="reserved">this</span>.highlightArea(obj.aid, <span class="literal">'grad'</span>);
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handles event of mouseout on imgmap areas.
 *	Calls gradient blur on the given area.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	e	The event object 
 */</span>
imgmap.<span class="reserved">prototype</span>.area_mouseout = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1 &amp;&amp; <span class="reserved">this</span>.config.mode !== <span class="literal">''</span>) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.is_drawing) {
		<span class="comment">//this.log('area_mouseout');</span>
		<span class="comment">//identify source object</span>
		var obj = (<span class="reserved">this</span>.isMSIE) ? window.event.srcElement : e.currentTarget;
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'DIV'</span>) {
			<span class="comment">//do this because of label</span>
			obj = obj.parentNode;
		}
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'image'</span> || obj.tagName == <span class="literal">'group'</span> ||
			obj.tagName == <span class="literal">'shape'</span> || obj.tagName == <span class="literal">'stroke'</span>) {
			<span class="comment">//do this because of excanvas</span>
			obj = obj.parentNode.parentNode;
		}
		<span class="reserved">this</span>.blurArea(obj.aid, <span class="literal">'grad'</span>);
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handles event of mousedown on imgmap areas.
 *	Sets the variables draggedid, selectedid and currentid to the given area. 
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	e	The event object 
 */</span>
imgmap.<span class="reserved">prototype</span>.area_mousedown = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="comment">//console.log('area_mousedown');</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.is_drawing) {
		var obj = (<span class="reserved">this</span>.isMSIE) ? window.event.srcElement : e.currentTarget;
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'DIV'</span>) {
			<span class="comment">//do this because of label</span>
			obj = obj.parentNode;
		}
		<span class="reserved">if</span> (obj.tagName == <span class="literal">'image'</span> || obj.tagName == <span class="literal">'group'</span> ||
			obj.tagName == <span class="literal">'shape'</span> || obj.tagName == <span class="literal">'stroke'</span>) {
			<span class="comment">//do this because of excanvas</span>
			obj = obj.parentNode.parentNode;
		}
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid] != obj) {
			<span class="comment">//trying to draw on a different canvas, switch to this one</span>
			<span class="reserved">if</span> (typeof obj.aid == <span class="literal">'undefined'</span>) {
				<span class="reserved">this</span>.log(<span class="literal">'Cannot identify target area'</span>, 1);
				<span class="reserved">return</span>;
			}
			<span class="reserved">this</span>.currentid = obj.aid;
		}
		<span class="comment">//this.log('selected = '+this.currentid);</span>
		<span class="reserved">this</span>.draggedId  = <span class="reserved">this</span>.currentid;
		<span class="reserved">this</span>.selectedId = <span class="reserved">this</span>.currentid;
		<span class="reserved">this</span>.fireEvent(<span class="literal">'onSelectArea'</span>, <span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid]);
		<span class="comment">//stop event propagation to document level</span>
		<span class="reserved">if</span> (<span class="reserved">this</span>.isMSIE) {
			window.event.cancelBubble = true;
		}
		<span class="reserved">else</span> {
			e.stopPropagation();
		}
	}
	<span class="reserved">else</span> {
		<span class="comment">//if drawing and not ie, have to propagate to image event</span>
		<span class="comment">//console.log('propdown');</span>
		<span class="reserved">this</span>.img_mousedown(e);
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handles event 'keydown' on document.
 *	Handles SHIFT hold while drawing.
 *	Note: Safari doesn't generate keyboard events for modifiers:
 *	<span class="attrib">@url</span>	http://bugs.webkit.org/show_bug.cgi?id=11696 
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	e	The event object 
 */</span>
imgmap.<span class="reserved">prototype</span>.doc_keydown = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	var key = (<span class="reserved">this</span>.isMSIE) ? event.keyCode : e.keyCode;
	<span class="comment">//console.log(key);</span>
	<span class="reserved">if</span> (key == 46) {
		<span class="comment">//delete key pressed</span>
		<span class="reserved">if</span> (<span class="reserved">this</span>.selectedId !== null &amp;&amp; !<span class="reserved">this</span>.is_drawing) {<span class="reserved">this</span>.removeArea(<span class="reserved">this</span>.selectedId);}
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (key == 16) {
		<span class="comment">//shift key pressed</span>
		<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_RECTANGLE_DRAW) {
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_SQUARE_DRAW;
			<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.SQUARE2_DRAW);
		}
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handles event 'keyup' on document.
 *	Handles SHIFT release while drawing.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	e	The event object
 */</span>
imgmap.<span class="reserved">prototype</span>.doc_keyup = <span class="reserved">function</span>(e) {
	var key = (<span class="reserved">this</span>.isMSIE) ? event.keyCode : e.keyCode;
	<span class="comment">//alert(key);</span>
	<span class="reserved">if</span> (key == 16) {
		<span class="comment">//shift key released</span>
		<span class="reserved">if</span> (<span class="reserved">this</span>.is_drawing == <span class="reserved">this</span>.DM_SQUARE_DRAW &amp;&amp; <span class="reserved">this</span>.areas[<span class="reserved">this</span>.currentid].shape == <span class="literal">'rect'</span>) {
			<span class="comment">//not for circle!</span>
			<span class="reserved">this</span>.is_drawing = <span class="reserved">this</span>.DM_RECTANGLE_DRAW;
			<span class="reserved">this</span>.statusMessage(<span class="reserved">this</span>.strings.RECTANGLE_DRAW);
		}
	}
};


<span class="comment">/**
 *	EVENT HANDLER: Handles event 'mousedown' on document.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@param</span>	e	The event object 
 */</span>
imgmap.<span class="reserved">prototype</span>.doc_mousedown = <span class="reserved">function</span>(e) {
	<span class="reserved">if</span> (<span class="reserved">this</span>.viewmode === 1) {<span class="reserved">return</span>;}<span class="comment">//exit if preview mode</span>
	<span class="reserved">if</span> (!<span class="reserved">this</span>.is_drawing) {
		<span class="reserved">this</span>.selectedId = null;
	}
};


<span class="comment">/**
 *	Get the real position of the element.
 *	Deal with browser differences when trying to get the position of an area.
 *	<span class="attrib">@param</span>	element	The element you want the position of.
 *	<span class="attrib">@return</span>	An object with x and y members.
 */</span>
imgmap.<span class="reserved">prototype</span>._getPos = <span class="reserved">function</span>(element) {
	var xpos = 0;
	var ypos = 0;
	<span class="reserved">if</span> (element) {
		var elementOffsetParent = element.offsetParent;
		<span class="comment">// If the element has an offset parent</span>
		<span class="reserved">if</span> (elementOffsetParent) {
			<span class="comment">// While there is an offset parent</span>
			<span class="reserved">while</span> ((elementOffsetParent = element.offsetParent)) {
				xpos += element.offsetLeft;
				ypos += element.offsetTop;
				element = elementOffsetParent;
			}
		}
		<span class="reserved">else</span> {
			xpos = element.offsetLeft;
			ypos = element.offsetTop;
		}
	}
	<span class="reserved">return</span> {x: xpos, y: ypos};
};


<span class="comment">/**
 *	Gets the last (visible and editable) area.
 *	<span class="attrib">@author</span>	Adam Maschek (adam.maschek(at)gmail.com)
 *	<span class="attrib">@date</span>	2006-06-15 16:34:51
 *	<span class="attrib">@returns</span>	The last area object or null. 
 */</span>
imgmap.<span class="reserved">prototype</span>._getLastArea = <span class="reserved">function</span>() {
	<span class="reserved">for</span> (var i = <span class="reserved">this</span>.areas.length-1; i&gt;=0; i--) {
		<span class="reserved">if</span> (<span class="reserved">this</span>.areas[i]) {
			<span class="reserved">return</span> <span class="reserved">this</span>.areas[i];
		}
	}
	<span class="reserved">return</span> null;
};


<span class="comment">/**
 *	Tries to copy imagemap html or text parameter to the clipboard.
 *	Not sure if this should really be part of the mapping code.
 *	If in special environment (eg AIR), use specific functions. 
 *	<span class="attrib">@date</span>	2006.10.24. 22:14:12
 *	<span class="attrib">@param</span>	text	Text to copy, otherwise getMapHTML will be used.
 *	<span class="attrib">@see</span>	#getMapHTML
 */</span>
imgmap.<span class="reserved">prototype</span>.toClipBoard = <span class="reserved">function</span>(text) {
	<span class="reserved">this</span>.fireEvent(<span class="literal">'onClipboard'</span>, text);
	<span class="reserved">if</span> (typeof text == <span class="literal">'undefined'</span>) {text = <span class="reserved">this</span>.getMapHTML();}
	<span class="comment">//alert(typeof window.clipboardData);</span>
	try {
		<span class="reserved">if</span> (window.clipboardData) {
			<span class="comment">// IE send-to-clipboard method.</span>
			window.clipboardData.setData(<span class="literal">'Text'</span>, text);
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (window.netscape) {
			<span class="comment">// You have to sign the code to enable this or allow the action in</span>
			<span class="comment">// about:config by changing user_pref("signed.applets.codebase_principal_support", true);</span>
			netscape.security.PrivilegeManager.enablePrivilege(<span class="literal">'UniversalXPConnect'</span>);
			
			<span class="comment">// Store support string in an object.</span>
			var str = Components.classes[<span class="literal">"@mozilla.org/supports-string;1"</span>].createInstance(Components.interfaces.nsISupportsString);
			<span class="reserved">if</span> (!str) {<span class="reserved">return</span> false;}
			str.data = text;
			
			<span class="comment">// Make transferable.</span>
			var trans = Components.classes[<span class="literal">"@mozilla.org/widget/transferable;1"</span>].createInstance(Components.interfaces.nsITransferable);
			<span class="reserved">if</span> (!trans) {<span class="reserved">return</span> false;}
			
			<span class="comment">// Specify what datatypes we want to obtain, which is text in this case.</span>
			trans.addDataFlavor(<span class="literal">"text/unicode"</span>);
			trans.setTransferData(<span class="literal">"text/unicode"</span>, str, text.length*2);
			
			var clipid = Components.interfaces.nsIClipboard;
			var clip   = Components.classes[<span class="literal">"@mozilla.org/widget/clipboard;1"</span>].getService(clipid);
			<span class="reserved">if</span> (!clip) {<span class="reserved">return</span> false;}
	
			clip.setData(trans, null, clipid.kGlobalClipboard);
		}
		<span class="reserved">else</span> <span class="reserved">if</span> (typeof air == <span class="literal">'object'</span>) {
			air.Clipboard.generalClipboard.clear();
			air.Clipboard.generalClipboard.setData(<span class="literal">"air:text"</span>, text, false);
		}
	}
	catch (err) {
		<span class="reserved">this</span>.log(<span class="literal">"Unable to set clipboard data"</span>, 1);
	}
};


<span class="comment">/**
 *	Parses cssText to single style declarations.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@date</span>	25-09-2007 18:19:51
 *	<span class="attrib">@param</span> obj	The DOM object to apply styles on.
 *	<span class="attrib">@param</span> cssText	The css declarations to apply.
 */</span>
imgmap.<span class="reserved">prototype</span>.assignCSS = <span class="reserved">function</span>(obj, cssText) {
	var parts = cssText.split(<span class="literal">';'</span>);
	<span class="reserved">for</span> (var i=0; i&lt;parts.length; i++) {
		var p = parts[i].split(<span class="literal">':'</span>);
		<span class="comment">//we need to camelcase by - signs</span>
		var pp = p[0].trim().split(<span class="literal">'-'</span>);
		var prop = pp[0];
		<span class="reserved">for</span> (var j=1; j&lt;pp.length; j++) {
			<span class="comment">//replace first letters to uppercase</span>
			prop+= pp[j].replace(/^./, pp[j].substring(0,1).toUpperCase());
		}
		obj.style[prop.trim()] = p[1].trim();
	}
};


<span class="comment">/**
 *	To fire callback hooks on custom events, passing them the object of the event.
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@date</span>	13-10-2007 15:24:49
 *	<span class="attrib">@param</span> evt	The type of event
 *	<span class="attrib">@param</span> obj	The object of the event. (can be an id, a string, an object, whatever is most relevant)  
 */</span>   
imgmap.<span class="reserved">prototype</span>.fireEvent = <span class="reserved">function</span>(evt, obj) {
	<span class="comment">//this.log("Firing event: " + evt);</span>
	<span class="reserved">if</span> (typeof <span class="reserved">this</span>.config.custom_callbacks[evt] == <span class="literal">'function'</span>) {
		<span class="reserved">return</span> <span class="reserved">this</span>.config.custom_callbacks[evt](obj);
	}
};


<span class="comment">/**
 *	To set area dimensions.
 *	This is needed to achieve the same result in all browsers. 
 *	<span class="attrib">@author</span>	adam
 *	<span class="attrib">@date</span>	10-12-2007 22:29:41
 *	<span class="attrib">@param</span>	id	The id of the area (canvas) to resize.
 *	<span class="attrib">@param</span>	w	The desired width in pixels.
 *	<span class="attrib">@param</span>	h	The desired height in pixels.
 */</span>
imgmap.<span class="reserved">prototype</span>.setAreaSize = <span class="reserved">function</span>(id, w, h) {
	<span class="reserved">if</span> (!id) {id = <span class="reserved">this</span>.currentid;}
	<span class="reserved">if</span> (w !== null) {
		<span class="reserved">this</span>.areas[id].width  = w;
		<span class="reserved">this</span>.areas[id].style.width  = (w) + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.areas[id].setAttribute(<span class="literal">'width'</span>,  w);
	}
	<span class="reserved">if</span> (h !== null) {
		<span class="reserved">this</span>.areas[id].height = h;
		<span class="reserved">this</span>.areas[id].style.height = (h) + <span class="literal">'px'</span>;
		<span class="reserved">this</span>.areas[id].setAttribute(<span class="literal">'height'</span>, h);
	}
};


<span class="comment">/**
 *	Tries to detect preferred language of user.
 *	<span class="attrib">@date</span>	2007.12.28. 15:43:46
 *	<span class="attrib">@return</span> The two byte language code. (We dont care now for pt-br, etc.)
 */</span>
imgmap.<span class="reserved">prototype</span>.detectLanguage = <span class="reserved">function</span>() {
	var lang;
	<span class="reserved">if</span> (navigator.userLanguage) {
		lang = navigator.userLanguage.toLowerCase();
	}
	<span class="reserved">else</span> <span class="reserved">if</span> (navigator.language) {
		lang = navigator.language.toLowerCase();
	}
	<span class="reserved">else</span> {
		<span class="reserved">return</span> <span class="reserved">this</span>.config.defaultLang;
	}
	<span class="comment">//this.log(lang, 2);</span>
	<span class="reserved">if</span> (lang.length &gt;= 2) {
		lang = lang.substring(0,2);
		<span class="reserved">return</span> lang;
	}
	<span class="reserved">return</span> <span class="reserved">this</span>.config.defaultLang;
};


<span class="comment">/**
 *	Disable selection on a given object.
 *	This is especially useful in Safari, where dragging around areas
 *	keeps selecting all sorts of things.
 *	<span class="attrib">@author</span>	Bret Taylor
 *	<span class="attrib">@url</span>	http://ajaxcookbook.org/disable-text-selection/
 *	<span class="attrib">@date</span>	27-07-2008 1:57:45
 *	<span class="attrib">@param</span>	element	The dom element on which you want to disable selection.
 */</span>       
imgmap.<span class="reserved">prototype</span>.disableSelection = <span class="reserved">function</span>(element) {
	<span class="reserved">if</span> (typeof element == <span class="literal">'undefined'</span> || !element) {<span class="reserved">return</span> false;}
	<span class="reserved">if</span> (typeof element.onselectstart != <span class="literal">"undefined"</span>) {
	    element.onselectstart = <span class="reserved">function</span>() {
	        <span class="reserved">return</span> false;
	    };
    }
    <span class="reserved">if</span> (typeof element.unselectable != <span class="literal">"undefined"</span>) {
    	element.unselectable = <span class="literal">"on"</span>;
    }
    <span class="reserved">if</span> (typeof element.style.MozUserSelect != <span class="literal">"undefined"</span>) {
    	element.style.MozUserSelect = <span class="literal">"none"</span>;
    }
};


<span class="comment">/**
 *	<span class="attrib">@date</span>	11-02-2007 19:57:05
 *	<span class="attrib">@url</span>	http://www.deepwood.net/writing/method-references.html.utf8
 *	<span class="attrib">@author</span>	Daniel Brockman
 *	<span class="attrib">@addon</span>
 */</span>
Function.<span class="reserved">prototype</span>.bind = <span class="reserved">function</span>(object) {
	var method = <span class="reserved">this</span>;
	<span class="reserved">return</span> <span class="reserved">function</span> () {
		<span class="reserved">return</span> method.apply(object, arguments);
	};
};


<span class="comment">/**
 *	Extends String with trim function.
 *	<span class="attrib">@url</span>	http://www.somacon.com/p355.php
 *	<span class="attrib">@addon</span>
 */</span>
String.<span class="reserved">prototype</span>.trim = <span class="reserved">function</span>() {
	<span class="reserved">return</span> <span class="reserved">this</span>.replace(/^\s+|\s+$/g,<span class="literal">""</span>);
};
<span class="comment">/**
 *	Extends String with ltrim function.
 *	<span class="attrib">@url</span>	http://www.somacon.com/p355.php
 *	<span class="attrib">@addon</span>
 */</span>
String.<span class="reserved">prototype</span>.ltrim = <span class="reserved">function</span>() {
	<span class="reserved">return</span> <span class="reserved">this</span>.replace(/^\s+/,<span class="literal">""</span>);
};
<span class="comment">/**
 *	Extends String with rtrim function.
 *	<span class="attrib">@url</span>	http://www.somacon.com/p355.php
 *	<span class="attrib">@addon</span>
 */</span>
String.<span class="reserved">prototype</span>.rtrim = <span class="reserved">function</span>() {
	<span class="reserved">return</span> <span class="reserved">this</span>.replace(/\s+$/,<span class="literal">""</span>);
};


<span class="comment">/**
 *	Spawn an imgmap object for each imagemap found in the document.
 *	This is used for highlighter mode only.
 *	<span class="attrib">@param</span> config	An imgmap config object  
 */</span>
<span class="reserved">function</span> imgmap_spawnObjects(config) {
	<span class="comment">//console.log('spawnobjects');</span>
	var maps = document.getElementsByTagName(<span class="literal">'map'</span>);
	var imgs = document.getElementsByTagName(<span class="literal">'img'</span>);
	var imaps = [];
	<span class="comment">//console.log(maps.length);</span>
	<span class="reserved">for</span> (var i=0; i&lt;maps.length; i++) {
		<span class="reserved">for</span> (var j=0; j&lt;imgs.length; j++) {
		<span class="comment">//console.log(i);</span>
		<span class="comment">//	console.log(maps[i].name);</span>
		<span class="comment">//	console.log(imgs[j].getAttribute('usemap'));</span>
			<span class="reserved">if</span> (<span class="literal">'#'</span> + maps[i].name == imgs[j].getAttribute(<span class="literal">'usemap'</span>)) {
				<span class="comment">//we found one matching pair</span>
			<span class="comment">//	console.log(maps[i]);</span>
				config.mode = <span class="literal">''</span>;
				imapn = new imgmap(config);
				<span class="comment">//imapn.setup(config);</span>
				imapn.useImage(imgs[j]);
				imapn.setMapHTML(maps[i]);
				imapn.viewmode = 1;
				
				imaps.push(imapn);
				
			}
		}
	}
}

<span class="comment">//global instance?</span>
<span class="comment">//imgmap_spawnObjects();?</span>
</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b>imgmap</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Fri Oct 31 12:35:44 2008</div>
</body>
</html>
